<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather Edge Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ================================================================
   DELIGHTFUL DESIGN SYSTEM — Neo-Brutalist Weather Trader
   ================================================================ */

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Backgrounds (warm cream) */
  --bg-page: oklch(0.982 0.008 70);
  --bg-surface: oklch(0.995 0.004 70);
  --bg-elevated: oklch(1.00 0.00 0);
  --bg-subtle: oklch(0.965 0.012 70);
  --bg-muted: oklch(0.948 0.014 70);

  /* Text */
  --text-primary: oklch(0.200 0.015 60);
  --text-secondary: oklch(0.420 0.015 60);
  --text-muted: oklch(0.560 0.012 60);
  --text-on-accent: oklch(1.00 0.000 0);

  /* Colors */
  --accent-primary: oklch(0.640 0.270 350);
  --accent-danger: oklch(0.620 0.220 20);
  --accent-gold: oklch(0.840 0.175 85);
  --accent-cyan: oklch(0.650 0.148 210);
  --accent-green: oklch(0.630 0.170 148);

  /* Typography */
  --font-sans: 'Inter', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;

  /* Fluid type scale */
  --step-0: clamp(0.875rem, 0.8rem + 0.25vw, 1rem);
  --step-1: clamp(1rem, 0.9rem + 0.35vw, 1.2rem);
  --step-2: clamp(1.2rem, 1rem + 0.5vw, 1.5rem);
  --step-3: clamp(1.5rem, 1.2rem + 0.7vw, 2rem);
  --step-4: clamp(2rem, 1.6rem + 1vw, 2.8rem);
  --step-5: clamp(2.8rem, 2rem + 1.5vw, 4rem);

  /* Borders & Shadows (Neo-Brutalist) */
  --border-width: 2px;
  --border-color: var(--text-primary);
  --radius-sm: 10px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --shadow-sm: 2px 2px 0 var(--text-primary);
  --shadow-md: 4px 4px 0 var(--text-primary);
  --shadow-lg: 8px 8px 0 var(--text-primary);

  /* Motion */
  --motion-fast: 160ms;
  --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);

  /* Spacing */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;

  /* Overlay */
  --overlay-bg: oklch(0.200 0.015 60 / 0.30);
}

/* ── Dark Mode (synced with delightful-design-system) ── */
[data-theme="dark"] {
  /* Warm dark backgrounds — hue 65 for amber-tinted darkness */
  --bg-page: oklch(0.140 0.014 65);
  --bg-surface: oklch(0.165 0.015 65);
  --bg-elevated: oklch(0.190 0.015 65);
  --bg-subtle: oklch(0.210 0.015 65);
  --bg-muted: oklch(0.180 0.013 65);

  /* Text */
  --text-primary: oklch(0.935 0.008 70);
  --text-secondary: oklch(0.690 0.012 70);
  --text-muted: oklch(0.540 0.010 70);
  --text-on-accent: oklch(1.00 0.000 0);
  --text-on-gold: oklch(0.140 0.014 65);

  /* Borders */
  --border-color: var(--text-primary);
  --border-subtle: oklch(0.330 0.015 65);

  /* Accent colors — brighter for dark backgrounds */
  --accent-primary: oklch(0.700 0.230 350);
  --accent-primary-hover: oklch(0.740 0.220 350);
  --accent-primary-subtle: oklch(0.250 0.065 350);
  --accent-primary-text: oklch(0.750 0.210 350);

  --accent-danger: oklch(0.660 0.200 20);
  --accent-danger-hover: oklch(0.700 0.190 20);
  --accent-danger-subtle: oklch(0.250 0.055 20);
  --accent-danger-text: oklch(0.720 0.180 20);

  --accent-gold: oklch(0.840 0.170 85);
  --accent-gold-hover: oklch(0.870 0.155 84);
  --accent-gold-subtle: oklch(0.260 0.065 85);
  --accent-gold-text: oklch(0.870 0.155 85);

  --accent-cyan: oklch(0.720 0.140 210);
  --accent-cyan-hover: oklch(0.760 0.130 210);
  --accent-cyan-subtle: oklch(0.250 0.045 210);
  --accent-cyan-text: oklch(0.780 0.130 210);

  --accent-green: oklch(0.680 0.155 148);
  --accent-green-hover: oklch(0.720 0.145 148);
  --accent-green-subtle: oklch(0.250 0.048 148);
  --accent-green-text: oklch(0.740 0.145 148);

  /* Overlay */
  --overlay-bg: oklch(0 0 0 / 0.60);

  /* Neo-Brutalist shadows — cream on dark for visible 3D */
  --shadow-sm: 2px 2px 0 oklch(0.92 0.010 65);
  --shadow-md: 4px 4px 0 oklch(0.92 0.010 65);
  --shadow-lg: 8px 8px 0 oklch(0.92 0.010 65);
  --shadow-pink: 4px 4px 0 var(--accent-primary);
  --shadow-danger: 4px 4px 0 var(--accent-danger);
  --shadow-gold: 4px 4px 0 var(--accent-gold);
  --shadow-cyan: 4px 4px 0 var(--accent-cyan);
  --shadow-green: 4px 4px 0 var(--accent-green);
}

html { font-size: 16px; scroll-behavior: smooth; }

body {
  font-family: var(--font-sans);
  background: var(--bg-page);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* ================================================================
   LAYOUT
   ================================================================ */

.app {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 var(--space-lg) var(--space-2xl);
}

/* ── Topbar ── */
.topbar {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  padding: var(--space-md) 0;
  border-bottom: var(--border-width) solid var(--border-color);
  margin-bottom: var(--space-lg);
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg-page);
}

.topbar-brand {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.topbar-logo {
  width: 36px;
  height: 36px;
  background: var(--accent-primary);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.topbar-title {
  font-family: var(--font-sans);
  font-weight: 900;
  font-size: var(--step-2);
  letter-spacing: -0.03em;
}

.topbar-spacer { flex: 1; }

.topbar-stats {
  display: flex;
  align-items: center;
  gap: var(--space-lg);
}

.topbar-stat {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 1px;
}

.topbar-stat-label {
  font-size: 0.65rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.topbar-stat-value {
  font-family: var(--font-mono);
  font-size: var(--step-0);
  font-weight: 700;
}

.topbar-divider {
  width: var(--border-width);
  height: 32px;
  background: var(--border-color);
}

/* ── Status Badge ── */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 4px 12px;
  border-radius: 100px;
  border: var(--border-width) solid var(--border-color);
  box-shadow: var(--shadow-sm);
}

.status-badge.live {
  background: var(--accent-green);
  color: var(--text-on-accent);
}

.status-badge.halted {
  background: var(--accent-danger);
  color: var(--text-on-accent);
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ── Theme Toggle ── */
.theme-toggle {
  width: 40px;
  height: 40px;
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--bg-elevated);
  box-shadow: var(--shadow-sm);
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: transform var(--motion-fast) var(--ease-out),
              box-shadow var(--motion-fast) var(--ease-out);
}

[data-theme="dark"] .theme-toggle {
  border-color: var(--border-subtle);
  box-shadow: none;
}

.theme-toggle:hover {
  transform: translate(-2px, -2px);
  box-shadow: var(--shadow-md);
}

[data-theme="dark"] .theme-toggle:hover {
  box-shadow: var(--shadow-sm);
}

.theme-toggle:active {
  transform: translate(2px, 2px);
  box-shadow: none;
}

/* ── Kill Switch ── */
.kill-switch-wrap {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.kill-label {
  font-size: 0.65rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--accent-danger);
}

.kill-toggle {
  position: relative;
  width: 48px;
  height: 26px;
  cursor: pointer;
}

.kill-toggle input { display: none; }

.kill-track {
  position: absolute;
  inset: 0;
  border-radius: 13px;
  background: var(--bg-muted);
  border: var(--border-width) solid var(--border-color);
  transition: all var(--motion-fast) var(--ease-out);
}

.kill-knob {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--text-secondary);
  border: var(--border-width) solid var(--border-color);
  transition: all var(--motion-fast) var(--ease-out);
  z-index: 1;
}

.kill-toggle input:checked ~ .kill-track {
  background: var(--accent-danger);
  border-color: var(--accent-danger);
}

.kill-toggle input:checked ~ .kill-knob {
  left: 25px;
  background: var(--text-on-accent);
}

/* ── Tab Navigation ── */
.tab-nav {
  display: flex;
  gap: var(--space-xs);
  padding: var(--space-md) 0;
  margin-bottom: var(--space-lg);
  overflow-x: auto;
}

.tab-btn {
  font-family: var(--font-sans);
  font-weight: 700;
  font-size: var(--step-0);
  padding: var(--space-sm) var(--space-md);
  border: var(--border-width) solid transparent;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--motion-fast) var(--ease-out);
  white-space: nowrap;
}

.tab-btn:hover {
  background: var(--bg-subtle);
  color: var(--text-primary);
}

.tab-btn.active {
  background: var(--text-primary);
  color: var(--bg-page);
  border-color: var(--border-color);
  box-shadow: var(--shadow-sm);
}

/* ── Tab Panels ── */
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ================================================================
   CARDS — Neo-Brutalist
   ================================================================ */

.card {
  background: var(--bg-surface);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-md);
  padding: var(--space-lg);
  transition: transform var(--motion-fast) var(--ease-out),
              box-shadow var(--motion-fast) var(--ease-out);
}

.card-hoverable:hover {
  transform: translate(-4px, -4px);
  box-shadow: var(--shadow-lg);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-md);
}

.card-title {
  font-weight: 800;
  font-size: var(--step-1);
  letter-spacing: -0.02em;
}

.card-subtitle {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 2px;
}

/* ── Metric Cards ── */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-md);
  margin-bottom: var(--space-lg);
}

.metric-card {
  background: var(--bg-surface);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  padding: var(--space-md) var(--space-lg);
  transition: transform var(--motion-fast) var(--ease-out),
              box-shadow var(--motion-fast) var(--ease-out);
}

.metric-card:hover {
  transform: translate(-2px, -2px);
  box-shadow: var(--shadow-md);
}

.metric-label {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: var(--space-xs);
}

.metric-value {
  font-family: var(--font-mono);
  font-size: var(--step-3);
  font-weight: 700;
  letter-spacing: -0.02em;
}

.metric-sub {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
}

/* ── Color Variants ── */
.text-green { color: var(--accent-green); }
.text-red { color: var(--accent-danger); }
.text-cyan { color: var(--accent-cyan); }
.text-gold { color: var(--accent-gold); }
.text-pink { color: var(--accent-primary); }
.text-muted { color: var(--text-muted); }
.text-secondary { color: var(--text-secondary); }

.bg-green { background: var(--accent-green); color: var(--text-on-accent); }
.bg-red { background: var(--accent-danger); color: var(--text-on-accent); }
.bg-cyan { background: var(--accent-cyan); color: var(--text-on-accent); }
.bg-gold { background: var(--accent-gold); color: var(--text-primary); }
.bg-pink { background: var(--accent-primary); color: var(--text-on-accent); }

/* ================================================================
   BUTTONS
   ================================================================ */

.btn {
  font-family: var(--font-sans);
  font-weight: 700;
  font-size: var(--step-0);
  padding: var(--space-sm) var(--space-md);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-sm);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: var(--space-sm);
  transition: transform var(--motion-fast) var(--ease-out),
              box-shadow var(--motion-fast) var(--ease-out);
  box-shadow: var(--shadow-sm);
  text-decoration: none;
}

.btn:hover {
  transform: translate(-2px, -2px);
  box-shadow: var(--shadow-md);
}

.btn:active {
  transform: translate(2px, 2px);
  box-shadow: none;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: var(--shadow-sm);
}

.btn-primary {
  background: var(--accent-primary);
  color: var(--text-on-accent);
}

.btn-secondary {
  background: var(--bg-surface);
  color: var(--text-primary);
}

.btn-danger {
  background: var(--accent-danger);
  color: var(--text-on-accent);
}

.btn-success {
  background: var(--accent-green);
  color: var(--text-on-accent);
}

.btn-sm {
  font-size: 0.75rem;
  padding: var(--space-xs) var(--space-sm);
}

.btn-lg {
  font-size: var(--step-1);
  padding: var(--space-md) var(--space-xl);
  box-shadow: var(--shadow-md);
}

.btn-lg:hover { box-shadow: var(--shadow-lg); }

/* ================================================================
   FORMS
   ================================================================ */

.form-group {
  margin-bottom: var(--space-md);
}

.form-label {
  display: block;
  font-weight: 700;
  font-size: 0.8rem;
  margin-bottom: var(--space-xs);
  color: var(--text-secondary);
}

.form-input {
  width: 100%;
  font-family: var(--font-mono);
  font-size: var(--step-0);
  padding: var(--space-sm) var(--space-md);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--bg-elevated);
  color: var(--text-primary);
  transition: box-shadow var(--motion-fast) var(--ease-out);
}

.form-input:focus {
  outline: none;
  box-shadow: 0 0 0 3px var(--accent-primary);
}

/* ================================================================
   TABLES
   ================================================================ */

.table-wrap {
  overflow-x: auto;
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: var(--step-0);
}

th {
  font-weight: 700;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  text-align: left;
  padding: var(--space-sm) var(--space-md);
  background: var(--bg-subtle);
  border-bottom: var(--border-width) solid var(--border-color);
}

td {
  padding: var(--space-sm) var(--space-md);
  border-bottom: 1px solid var(--bg-muted);
  font-family: var(--font-mono);
  font-size: 0.85rem;
}

tr:last-child td { border-bottom: none; }

tr:hover td {
  background: var(--bg-subtle);
}

/* ================================================================
   BADGE / PILL
   ================================================================ */

.badge {
  display: inline-flex;
  align-items: center;
  font-family: var(--font-mono);
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 100px;
  border: var(--border-width) solid var(--border-color);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.badge-green { background: var(--accent-green); color: var(--text-on-accent); }
.badge-red { background: var(--accent-danger); color: var(--text-on-accent); }
.badge-cyan { background: var(--accent-cyan); color: var(--text-on-accent); }
.badge-gold { background: var(--accent-gold); color: var(--text-primary); }
.badge-pink { background: var(--accent-primary); color: var(--text-on-accent); }
.badge-muted {
  background: var(--bg-muted);
  color: var(--text-secondary);
  border-color: var(--text-muted);
}

/* ================================================================
   SAFETY RAILS
   ================================================================ */

.safety-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: var(--space-md);
}

.safety-item {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  padding: var(--space-md);
  background: var(--bg-subtle);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-sm);
}

.safety-icon {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  border: var(--border-width) solid var(--border-color);
  flex-shrink: 0;
}

.safety-ok .safety-icon { background: var(--accent-green); }
.safety-warn .safety-icon { background: var(--accent-gold); }
.safety-error .safety-icon { background: var(--accent-danger); }

.safety-text-label {
  font-weight: 700;
  font-size: 0.8rem;
}

.safety-text-value {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-secondary);
}

/* ================================================================
   EQUITY CURVE (Canvas)
   ================================================================ */

.equity-canvas-wrap {
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-md);
  background: var(--bg-surface);
  box-shadow: var(--shadow-md);
  padding: var(--space-md);
  margin-bottom: var(--space-lg);
}

.equity-canvas-wrap canvas {
  width: 100%;
  height: 260px;
  display: block;
}

/* ================================================================
   RECENT ACTIVITY (Dashboard)
   ================================================================ */

.activity-item {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  padding: var(--space-sm) 0;
  border-bottom: 1px solid var(--bg-muted);
}

.activity-item:last-child { border-bottom: none; }

.activity-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: var(--border-width) solid var(--border-color);
  flex-shrink: 0;
}

.activity-text {
  flex: 1;
  font-size: 0.85rem;
}

.activity-time {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-muted);
}

/* ================================================================
   BUCKET DISTRIBUTION CHART
   ================================================================ */

.event-card {
  background: var(--bg-surface);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-md);
  margin-bottom: var(--space-lg);
  overflow: hidden;
  transition: transform var(--motion-fast) var(--ease-out),
              box-shadow var(--motion-fast) var(--ease-out);
}

.event-card:hover {
  transform: translate(-2px, -2px);
  box-shadow: var(--shadow-lg);
}

.event-card-header {
  padding: var(--space-md) var(--space-lg);
  border-bottom: var(--border-width) solid var(--border-color);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: var(--space-md);
}

.event-meta {
  display: flex;
  gap: var(--space-sm);
  margin-top: var(--space-xs);
  flex-wrap: wrap;
}

.event-question {
  font-weight: 800;
  font-size: var(--step-1);
  letter-spacing: -0.01em;
}

.bucket-chart {
  padding: var(--space-md) var(--space-lg);
}

/* ── Bets Table ── */
.bets-table {
  width: 100%;
  border-collapse: collapse;
  font-size: var(--step--1);
}

.bets-table thead th {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: var(--space-sm) var(--space-md);
  border-bottom: var(--border-width) solid var(--border-color);
  text-align: left;
  white-space: nowrap;
}

.bets-table thead th.num { text-align: right; }

.bets-table tbody td {
  padding: var(--space-sm) var(--space-md);
  border-bottom: 1px solid var(--bg-muted);
  vertical-align: middle;
}

.bets-table tbody td.num {
  text-align: right;
  font-family: var(--font-mono);
  font-weight: 600;
  white-space: nowrap;
}

.bets-table tbody tr:last-child td { border-bottom: none; }

.bets-table tbody tr:hover {
  background: var(--bg-subtle);
}

.bet-label {
  font-weight: 700;
  color: var(--text-primary);
}

/* ── Bet Slip ── */
.bet-slip {
  position: fixed;
  bottom: var(--space-lg);
  right: var(--space-lg);
  width: 360px;
  background: var(--bg-elevated);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  z-index: 200;
  transform: translateY(calc(100% + 40px));
  transition: transform 300ms var(--ease-bounce);
  overflow: hidden;
}

.bet-slip.visible {
  transform: translateY(0);
}

.bet-slip-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-md) var(--space-lg);
  background: var(--accent-primary);
  color: var(--text-on-accent);
  font-weight: 800;
  font-size: var(--step-1);
  border-bottom: var(--border-width) solid var(--border-color);
}

.bet-slip-count {
  background: var(--text-on-accent);
  color: var(--accent-primary);
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 0.85rem;
  font-weight: 800;
  border: var(--border-width) solid var(--border-color);
}

.bet-slip-body {
  max-height: 300px;
  overflow-y: auto;
  padding: var(--space-md);
}

.bet-slip-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-sm);
  border-bottom: 1px solid var(--bg-muted);
  font-size: 0.8rem;
}

.bet-slip-item:last-child { border-bottom: none; }

.bet-slip-item-label {
  font-weight: 600;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.bet-slip-item-edge {
  font-family: var(--font-mono);
  font-weight: 700;
}

.bet-slip-footer {
  padding: var(--space-md) var(--space-lg);
  border-top: var(--border-width) solid var(--border-color);
}

/* ================================================================
   LOG VIEWER
   ================================================================ */

.log-viewer {
  background: var(--bg-surface);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-md);
  max-height: 600px;
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: 0.78rem;
}

.log-entry {
  display: grid;
  grid-template-columns: 180px 60px 1fr;
  gap: var(--space-sm);
  padding: var(--space-xs) var(--space-md);
  border-bottom: 1px solid var(--bg-muted);
  transition: background var(--motion-fast);
}

.log-entry:hover { background: var(--bg-subtle); }

.log-ts { color: var(--text-muted); }
.log-level { font-weight: 700; text-transform: uppercase; }
.log-level.info { color: var(--accent-cyan); }
.log-level.warning { color: var(--accent-gold); }
.log-level.error { color: var(--accent-danger); }
.log-level.debug { color: var(--text-muted); }
.log-msg { color: var(--text-primary); word-break: break-word; }

/* ================================================================
   ACCORDION (Settings)
   ================================================================ */

.accordion {
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.accordion-trigger {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-md) var(--space-lg);
  background: var(--bg-subtle);
  border: none;
  cursor: pointer;
  font-family: var(--font-sans);
  font-weight: 800;
  font-size: var(--step-0);
  color: var(--text-primary);
  transition: background var(--motion-fast);
}

.accordion-trigger:hover { background: var(--bg-muted); }

.accordion-arrow {
  transition: transform 300ms var(--ease-out);
  font-size: 1.2rem;
}

.accordion-trigger.open .accordion-arrow {
  transform: rotate(180deg);
}

.accordion-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 300ms var(--ease-out);
}

.accordion-content.open {
  max-height: 2000px;
}

.accordion-inner {
  padding: var(--space-lg);
  font-size: 0.9rem;
  line-height: 1.8;
  color: var(--text-secondary);
}

/* ================================================================
   POSITION CARD (Portfolio)
   ================================================================ */

.position-group {
  margin-bottom: var(--space-lg);
}

.position-group-title {
  font-weight: 800;
  font-size: var(--step-1);
  margin-bottom: var(--space-md);
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.position-group-count {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  font-weight: 700;
  color: var(--text-muted);
}

/* ================================================================
   LOADING / EMPTY STATES
   ================================================================ */

.loading-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-2xl);
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--bg-muted);
  border-top-color: var(--accent-primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
  text-align: center;
  padding: var(--space-2xl);
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: var(--space-md);
  opacity: 0.5;
}

.empty-state-text {
  font-weight: 600;
  font-size: var(--step-1);
}

/* ================================================================
   SETTINGS GRID
   ================================================================ */

.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: var(--space-md);
}

/* ================================================================
   RESPONSIVE
   ================================================================ */

@media (max-width: 900px) {
  .topbar-stats { display: none; }
  .metrics-grid { grid-template-columns: repeat(2, 1fr); }
  .bucket-row { grid-template-columns: 100px 1fr 60px 32px; }
  .bet-slip { width: calc(100vw - 32px); right: 16px; left: 16px; }
}

@media (max-width: 600px) {
  .app { padding: 0 var(--space-md); }
  .metrics-grid { grid-template-columns: 1fr; }
  .tab-btn { font-size: 0.8rem; padding: var(--space-xs) var(--space-sm); }
}

/* ================================================================
   TOAST NOTIFICATIONS
   ================================================================ */

.toast-container {
  position: fixed;
  top: var(--space-lg);
  right: var(--space-lg);
  z-index: 300;
  display: flex;
  flex-direction: column;
  gap: var(--space-sm);
}

.toast {
  padding: var(--space-md) var(--space-lg);
  background: var(--bg-elevated);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-md);
  font-weight: 600;
  font-size: 0.85rem;
  animation: toast-in 300ms var(--ease-bounce);
  max-width: 360px;
}

.toast.success { border-left: 4px solid var(--accent-green); }
.toast.error { border-left: 4px solid var(--accent-danger); }
.toast.info { border-left: 4px solid var(--accent-cyan); }

@keyframes toast-in {
  from { opacity: 0; transform: translateX(40px); }
  to { opacity: 1; transform: translateX(0); }
}

/* ================================================================
   SECTION HEADERS
   ================================================================ */

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-md);
}

.section-title {
  font-weight: 800;
  font-size: var(--step-2);
  letter-spacing: -0.02em;
}

/* ================================================================
   PORTFOLIO LIFECYCLE
   ================================================================ */

.lifecycle-tabs {
  display: flex;
  gap: var(--space-xs);
  margin-bottom: var(--space-md);
}

.lifecycle-tab {
  font-family: var(--font-sans);
  font-weight: 700;
  font-size: 0.8rem;
  padding: var(--space-xs) var(--space-md);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--bg-surface);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--motion-fast) var(--ease-out);
  box-shadow: var(--shadow-sm);
}

.lifecycle-tab.active {
  background: var(--text-primary);
  color: var(--bg-page);
}

.lifecycle-panel { display: none; }
.lifecycle-panel.active { display: block; }

/* ================================================================
   SCAN OVERLAY
   ================================================================ */

.scan-overlay {
  position: fixed;
  inset: 0;
  background: var(--overlay-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 250;
  opacity: 0;
  pointer-events: none;
  transition: opacity 200ms;
}

.scan-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.scan-modal {
  background: var(--bg-elevated);
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  padding: var(--space-2xl);
  text-align: center;
  max-width: 360px;
}

.scan-modal .spinner {
  width: 48px;
  height: 48px;
  margin: 0 auto var(--space-md);
}

.scan-modal p {
  font-weight: 700;
  font-size: var(--step-1);
}

</style>
</head>
<body>
<div class="app">

  <!-- ============================================================
       TOPBAR
       ============================================================ -->
  <header class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo">W</div>
      <span class="topbar-title">Weather Edge</span>
    </div>

    <div id="statusBadge" class="status-badge live">
      <span class="status-dot"></span>
      <span id="statusText">LIVE</span>
    </div>

    <div class="topbar-spacer"></div>

    <div class="topbar-stats">
      <div class="topbar-stat">
        <span class="topbar-stat-label">Bankroll</span>
        <span class="topbar-stat-value" id="topBankroll">$0</span>
      </div>
      <div class="topbar-divider"></div>
      <div class="topbar-stat">
        <span class="topbar-stat-label">Open</span>
        <span class="topbar-stat-value" id="topOpen">0</span>
      </div>
      <div class="topbar-divider"></div>
      <div class="topbar-stat">
        <span class="topbar-stat-label">P&L</span>
        <span class="topbar-stat-value" id="topPnl">$0.00</span>
      </div>
    </div>

    <div class="topbar-divider"></div>

    <div class="kill-switch-wrap">
      <span class="kill-label">Kill</span>
      <label class="kill-toggle">
        <input type="checkbox" id="killSwitch" onchange="toggleKillSwitch(this.checked)">
        <span class="kill-track"></span>
        <span class="kill-knob"></span>
      </label>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
      <span id="themeIcon">&#9790;</span>
    </button>
  </header>

  <!-- ============================================================
       TAB NAVIGATION
       ============================================================ -->
  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-btn" data-tab="markets" onclick="switchTab('markets')">Markets</button>
    <button class="tab-btn" data-tab="portfolio" onclick="switchTab('portfolio')">Portfolio</button>
    <button class="tab-btn" data-tab="activity" onclick="switchTab('activity')">Activity</button>
    <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">Settings</button>
  </nav>

  <!-- ============================================================
       TAB: DASHBOARD
       ============================================================ -->
  <section id="tab-dashboard" class="tab-panel active">

    <div class="metrics-grid" id="dashMetrics">
      <div class="metric-card">
        <div class="metric-label">Portfolio Value</div>
        <div class="metric-value" id="metricPortfolio">$0.00</div>
        <div class="metric-sub" id="metricPortfolioSub">--</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Realized P&L</div>
        <div class="metric-value" id="metricPnl">$0.00</div>
        <div class="metric-sub" id="metricPnlSub">--</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Open Positions</div>
        <div class="metric-value text-cyan" id="metricOpen">0</div>
        <div class="metric-sub" id="metricOpenSub">--</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Win Rate</div>
        <div class="metric-value" id="metricWinRate">--</div>
        <div class="metric-sub" id="metricWinRateSub">--</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Expected P&L</div>
        <div class="metric-value" id="metricExpected">$0.00</div>
        <div class="metric-sub">Weighted by NOAA prob</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Total Trades</div>
        <div class="metric-value text-pink" id="metricTotal">0</div>
        <div class="metric-sub" id="metricTotalSub">--</div>
      </div>
    </div>

    <!-- Equity Curve -->
    <div class="section-header">
      <h2 class="section-title">Equity Curve</h2>
    </div>
    <div class="equity-canvas-wrap">
      <canvas id="equityCanvas"></canvas>
    </div>

    <!-- Safety Rails -->
    <div class="section-header">
      <h2 class="section-title">Safety Rails</h2>
    </div>
    <div class="card" style="margin-bottom: var(--space-lg);">
      <div class="safety-grid" id="safetyGrid">
        <!-- Filled by JS -->
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="section-header">
      <h2 class="section-title">Recent Activity</h2>
    </div>
    <div class="card" id="recentActivity">
      <div class="empty-state">
        <div class="empty-state-text">No recent activity</div>
      </div>
    </div>
  </section>

  <!-- ============================================================
       TAB: MARKETS
       ============================================================ -->
  <section id="tab-markets" class="tab-panel">
    <div class="section-header">
      <h2 class="section-title">Scan for Bets</h2>
      <div style="display: flex; gap: var(--space-sm); align-items: center;">
        <button class="btn btn-primary btn-lg" onclick="scanEvents()" id="scanBtn">
          Scan Markets
        </button>
      </div>
    </div>

    <p id="marketsExplainer" style="color: var(--text-secondary); font-size: var(--step--1); margin: 0 0 var(--space-md) 0; max-width: 640px;">
      Scans Polymarket weather markets, compares prices to NOAA forecasts, and finds bets where the market is mispriced. Only bets with edge above your threshold are shown.
    </p>

    <div id="marketsContent">
      <div class="empty-state">
        <div class="empty-state-icon">&#127780;</div>
        <div class="empty-state-text">Click "Scan Markets" to find mispriced bets</div>
      </div>
    </div>
  </section>

  <!-- ============================================================
       TAB: PORTFOLIO
       ============================================================ -->
  <section id="tab-portfolio" class="tab-panel">
    <div class="section-header">
      <h2 class="section-title">Portfolio</h2>
      <button class="btn btn-secondary" onclick="loadPortfolio()">Refresh</button>
    </div>

    <div class="metrics-grid" id="portfolioMetrics">
      <!-- Filled by JS -->
    </div>

    <div class="lifecycle-tabs">
      <button class="lifecycle-tab active" data-lifecycle="open" onclick="switchLifecycle('open')">Open</button>
      <button class="lifecycle-tab" data-lifecycle="ready" onclick="switchLifecycle('ready')">Ready to Resolve</button>
      <button class="lifecycle-tab" data-lifecycle="resolved" onclick="switchLifecycle('resolved')">Resolved</button>
    </div>

    <div id="lifecycle-open" class="lifecycle-panel active">
      <div id="openPositions" class="loading-spinner"><div class="spinner"></div></div>
    </div>
    <div id="lifecycle-ready" class="lifecycle-panel">
      <div id="readyPositions" class="loading-spinner"><div class="spinner"></div></div>
    </div>
    <div id="lifecycle-resolved" class="lifecycle-panel">
      <div id="resolvedTrades" class="loading-spinner"><div class="spinner"></div></div>
    </div>

    <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-sm);">
      <button class="btn btn-success" onclick="resolveTrades()">Resolve Trades</button>
    </div>
  </section>

  <!-- ============================================================
       TAB: ACTIVITY
       ============================================================ -->
  <section id="tab-activity" class="tab-panel">
    <div class="section-header">
      <h2 class="section-title">Activity Log</h2>
      <div style="display: flex; align-items: center; gap: var(--space-md);">
        <label style="font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); color: var(--text-secondary);">
          <input type="checkbox" id="logAutoPoll" checked style="accent-color: var(--accent-primary);"> Auto-refresh
        </label>
        <button class="btn btn-secondary btn-sm" onclick="loadLogs()">Refresh</button>
      </div>
    </div>

    <div class="log-viewer" id="logViewer">
      <div class="empty-state">
        <div class="empty-state-text">Waiting for logs...</div>
      </div>
    </div>
  </section>

  <!-- ============================================================
       TAB: SETTINGS
       ============================================================ -->
  <section id="tab-settings" class="tab-panel">
    <div class="section-header">
      <h2 class="section-title">Configuration</h2>
    </div>

    <div class="card" style="margin-bottom: var(--space-lg);">
      <div class="settings-grid" id="settingsForm">
        <div class="form-group">
          <label class="form-label">Max Bankroll ($)</label>
          <input class="form-input" type="number" id="setMaxBankroll" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Position Cap (%)</label>
          <input class="form-input" type="number" id="setPositionCap" step="0.01" min="0" max="50">
        </div>
        <div class="form-group">
          <label class="form-label">Kelly Fraction</label>
          <input class="form-input" type="number" id="setKellyFraction" step="0.01" min="0" max="1">
        </div>
        <div class="form-group">
          <label class="form-label">Min Edge Threshold (%)</label>
          <input class="form-input" type="number" id="setEdgeThreshold" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Daily Loss Limit (%)</label>
          <input class="form-input" type="number" id="setDailyLoss" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Log Level</label>
          <select class="form-input" id="setLogLevel">
            <option value="DEBUG">DEBUG</option>
            <option value="INFO">INFO</option>
            <option value="WARNING">WARNING</option>
            <option value="ERROR">ERROR</option>
          </select>
        </div>
      </div>
      <div style="margin-top: var(--space-lg);">
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>

    <!-- How It Works Accordion -->
    <div class="accordion">
      <button class="accordion-trigger" onclick="toggleAccordion(this)">
        <span>How It Works</span>
        <span class="accordion-arrow">&#9660;</span>
      </button>
      <div class="accordion-content">
        <div class="accordion-inner">
          <p><strong>1. Scan</strong> &mdash; Polymarket is scanned for active weather markets (temperature, precipitation, snowfall).</p>
          <p><strong>2. Parse</strong> &mdash; Each market question is parsed to extract location, date, and threshold values.</p>
          <p><strong>3. Forecast</strong> &mdash; NOAA's National Blend of Models (NBM) provides probabilistic forecasts for the same location + date.</p>
          <p><strong>4. Compare</strong> &mdash; NOAA probability is compared to the Polymarket price. If the gap exceeds the min edge threshold (default 10%), a signal is generated.</p>
          <p><strong>5. Size</strong> &mdash; Position size uses quarter-Kelly: <code>f* = 0.25 &times; (p_noaa - p_market) / (1 - p_market)</code></p>
          <p><strong>6. Execute</strong> &mdash; Paper trade is placed in the simulator and logged to SQLite. No real money is involved.</p>
          <p><strong>7. Resolve</strong> &mdash; When the event date passes, trades are resolved against Polymarket settlement data or NOAA observations.</p>
          <br>
          <p><strong>Safety Rails:</strong> Hard bankroll ceiling, per-position cap (25% default), quarter-Kelly only, minimum 10% edge, daily loss limit (-5%), kill switch.</p>
        </div>
      </div>
    </div>
  </section>

</div><!-- /.app -->

<!-- Bet Slip (hidden - all bets placed via table button) -->
<div class="bet-slip" id="betSlip" style="display:none;">
  <div class="bet-slip-header"><span>Bet Slip</span><span class="bet-slip-count" id="betSlipCount">0</span></div>
  <div class="bet-slip-body" id="betSlipBody"></div>
  <div class="bet-slip-footer"><button class="btn btn-primary" id="betSlipExec">Place Bets</button></div>
</div>

<!-- Scan Overlay -->
<div class="scan-overlay" id="scanOverlay">
  <div class="scan-modal">
    <div class="spinner"></div>
    <p id="scanOverlayText">Scanning markets...</p>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
/* ================================================================
   STATE
   ================================================================ */

const state = {
  config: {},
  portfolio: null,
  events: [],
  signals: [],
  betSlipSelections: new Map(), // key: "eventId:bucketIndex" -> signal data
  logCursor: 0,
  logPollTimer: null,
  activeTab: 'dashboard',
};

/* ================================================================
   UTILITIES
   ================================================================ */

function $(id) { return document.getElementById(id); }

async function api(method, path, body = null) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: res.statusText }));
    throw new Error(err.error || res.statusText);
  }
  return res.json();
}

function fmt$(v) {
  const n = Number(v) || 0;
  return (n >= 0 ? '' : '-') + '$' + Math.abs(n).toFixed(2);
}

function fmtPct(v) {
  return (Number(v) * 100).toFixed(1) + '%';
}

function fmtPctPts(v) {
  return (Number(v) * 100).toFixed(1) + 'pp';
}

function fmtDate(d) {
  if (!d) return '--';
  const dt = new Date(d);
  return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function fmtTime(ts) {
  if (!ts) return '';
  try {
    const d = new Date(ts);
    return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  } catch { return ts; }
}

function fmtMetric(m) {
  const map = {
    'temperature_high': 'High Temp',
    'temperature_low': 'Low Temp',
    'precipitation': 'Precip',
    'snowfall': 'Snow',
  };
  return map[m] || m;
}

function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

function escHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

/* ================================================================
   TOAST
   ================================================================ */

function toast(message, type = 'info') {
  const container = $('toastContainer');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = message;
  container.appendChild(el);
  setTimeout(() => {
    el.style.opacity = '0';
    el.style.transform = 'translateX(40px)';
    el.style.transition = 'all 300ms';
    setTimeout(() => el.remove(), 300);
  }, 3500);
}

/* ================================================================
   THEME
   ================================================================ */

function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  $('themeIcon').innerHTML = isDark ? '&#9790;' : '&#9728;';
  localStorage.setItem('theme', isDark ? 'light' : 'dark');
}

(function initTheme() {
  const saved = localStorage.getItem('theme');
  if (saved === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    setTimeout(() => { $('themeIcon').innerHTML = '&#9728;'; }, 0);
  }
})();

/* ================================================================
   TABS
   ================================================================ */

function switchTab(tabId) {
  state.activeTab = tabId;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === `tab-${tabId}`));

  // Load data on tab switch
  if (tabId === 'dashboard') loadDashboard();
  if (tabId === 'portfolio') loadPortfolio();
  if (tabId === 'activity') { loadLogs(); startLogPolling(); }
  if (tabId === 'settings') loadSettings();
  if (tabId !== 'activity') stopLogPolling();
}

/* ================================================================
   LIFECYCLE TABS (Portfolio)
   ================================================================ */

function switchLifecycle(which) {
  document.querySelectorAll('.lifecycle-tab').forEach(b => b.classList.toggle('active', b.dataset.lifecycle === which));
  document.querySelectorAll('.lifecycle-panel').forEach(p => p.classList.toggle('active', p.id === `lifecycle-${which}`));
}

/* ================================================================
   ACCORDION
   ================================================================ */

function toggleAccordion(trigger) {
  trigger.classList.toggle('open');
  const content = trigger.nextElementSibling;
  content.classList.toggle('open');
}

/* ================================================================
   KILL SWITCH
   ================================================================ */

async function toggleKillSwitch(enabled) {
  try {
    const data = await api('PUT', '/api/kill-switch', { enabled });
    updateStatusUI(data);
    toast(enabled ? 'Kill switch ENGAGED' : 'Kill switch disengaged', enabled ? 'error' : 'success');
  } catch (e) {
    toast('Failed to toggle kill switch: ' + e.message, 'error');
    $('killSwitch').checked = !enabled;
  }
}

/* ================================================================
   STATUS & CONFIG
   ================================================================ */

async function loadStatus() {
  try {
    const data = await api('GET', '/api/status');
    state.config = data;
    updateStatusUI(data);
    return data;
  } catch (e) {
    toast('Failed to load status', 'error');
  }
}

function updateStatusUI(data) {
  state.config = data;

  // Kill switch
  $('killSwitch').checked = data.kill_switch;
  const badge = $('statusBadge');
  const statusText = $('statusText');
  if (data.kill_switch) {
    badge.className = 'status-badge halted';
    statusText.textContent = 'HALTED';
  } else {
    badge.className = 'status-badge live';
    statusText.textContent = 'LIVE';
  }

  // Topbar stats
  $('topBankroll').textContent = fmt$(data.max_bankroll);
  $('topOpen').textContent = data.open_bets || 0;
}

/* ================================================================
   DASHBOARD
   ================================================================ */

async function loadDashboard() {
  await loadStatus();
  loadPortfolioMetrics();
  loadEquityCurve();
  loadSafetyRails();
  loadRecentActivity();
}

async function loadPortfolioMetrics() {
  try {
    const data = await api('GET', '/api/portfolio');
    state.portfolio = data;

    // Map API fields to display
    const cash = Number(data.cash ?? data.available_bankroll ?? 0);
    const exposure = Number(data.exposure ?? data.total_invested ?? 0);
    const totalValue = Number(data.total_value ?? data.starting_bankroll ?? 0);
    const maxBankroll = Number(data.starting_bankroll ?? data.max_bankroll ?? 0);
    const openCount = Number(data.open ?? data.open_positions ?? 0);
    const resolvedCount = Number(data.resolved ?? 0);
    const pnl = Number(data.actual_pnl ?? data.realized_pnl ?? 0);
    const wins = Number(data.wins ?? 0);
    const losses = Number(data.losses ?? 0);

    $('metricPortfolio').textContent = fmt$(totalValue);
    $('metricPortfolioSub').textContent = `${fmt$(cash)} cash, ${fmt$(exposure)} invested`;

    $('metricPnl').textContent = fmt$(pnl);
    $('metricPnl').className = `metric-value ${pnl >= 0 ? 'text-green' : 'text-red'}`;
    $('metricPnlSub').textContent = `${wins}W / ${losses}L`;

    $('metricOpen').textContent = openCount;
    $('metricOpenSub').textContent = `${fmt$(exposure)} invested`;

    const total = wins + losses;
    if (total > 0) {
      const wr = ((wins / total) * 100).toFixed(0) + '%';
      $('metricWinRate').textContent = wr;
      $('metricWinRate').className = `metric-value ${wins / total >= 0.5 ? 'text-green' : 'text-gold'}`;
      $('metricWinRateSub').textContent = `${total} resolved`;
    } else {
      $('metricWinRate').textContent = '--';
      $('metricWinRate').className = 'metric-value';
      $('metricWinRateSub').textContent = 'No resolved trades';
    }

    const expected = Number(data.estimated_expected_pnl ?? 0);
    $('metricExpected').textContent = fmt$(expected);
    $('metricExpected').className = `metric-value ${expected >= 0 ? 'text-green' : 'text-red'}`;

    const totalTrades = Number(data.total ?? data.total_trades ?? 0);
    $('metricTotal').textContent = totalTrades;
    $('metricTotalSub').textContent = `${openCount} open, ${resolvedCount} resolved`;

    // Update topbar
    $('topPnl').textContent = fmt$(pnl);
    $('topBankroll').textContent = fmt$(cash);
    $('topOpen').textContent = openCount;
    $('topPnl').className = `topbar-stat-value ${pnl >= 0 ? 'text-green' : 'text-red'}`;
  } catch (e) {
    console.error('Portfolio metrics error:', e);
  }
}

/* ── Equity Curve (Canvas) ── */

async function loadEquityCurve() {
  try {
    const data = await api('GET', '/api/snapshots?days=90');
    const snapshots = data.snapshots || [];
    if (snapshots.length < 2) {
      const canvas = $('equityCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth * 2;
      canvas.height = 520;
      ctx.scale(2, 2);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim();
      ctx.font = '600 14px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Not enough data for equity curve', canvas.offsetWidth / 2, 130);
      return;
    }
    drawEquityCurve(snapshots);
  } catch (e) {
    console.error('Equity curve error:', e);
  }
}

function drawEquityCurve(snapshots) {
  const canvas = $('equityCanvas');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.offsetWidth;
  const h = 260;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const cs = getComputedStyle(document.documentElement);
  const textMuted = cs.getPropertyValue('--text-muted').trim() || 'oklch(0.54 0.01 70)';
  const textPrimary = cs.getPropertyValue('--text-primary').trim() || 'oklch(0.20 0.015 60)';
  const accentPrimary = cs.getPropertyValue('--accent-primary').trim() || 'oklch(0.64 0.27 350)';
  const accentGreen = cs.getPropertyValue('--accent-green').trim() || 'oklch(0.63 0.17 148)';
  const bgMuted = cs.getPropertyValue('--bg-muted').trim() || 'oklch(0.948 0.014 70)';

  const pad = { top: 20, right: 20, bottom: 40, left: 70 };
  const cw = w - pad.left - pad.right;
  const ch = h - pad.top - pad.bottom;

  const values = snapshots.map(s => Number(s.portfolio_value || s.total_value || 0));
  const dates = snapshots.map(s => s.snapshot_date || s.date);
  const minV = Math.min(...values) * 0.98;
  const maxV = Math.max(...values) * 1.02;
  const range = maxV - minV || 1;

  function xPos(i) { return pad.left + (i / (values.length - 1)) * cw; }
  function yPos(v) { return pad.top + ch - ((v - minV) / range) * ch; }

  // Grid lines
  ctx.strokeStyle = bgMuted;
  ctx.lineWidth = 1;
  const gridSteps = 5;
  for (let i = 0; i <= gridSteps; i++) {
    const y = pad.top + (ch / gridSteps) * i;
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(w - pad.right, y);
    ctx.stroke();

    const val = maxV - (i / gridSteps) * range;
    ctx.fillStyle = textMuted;
    ctx.font = '500 11px JetBrains Mono, monospace';
    ctx.textAlign = 'right';
    ctx.fillText(fmt$(val), pad.left - 8, y + 4);
  }

  // Date labels
  ctx.textAlign = 'center';
  const labelCount = Math.min(dates.length, 6);
  for (let i = 0; i < labelCount; i++) {
    const idx = Math.round((i / (labelCount - 1)) * (dates.length - 1));
    const x = xPos(idx);
    ctx.fillStyle = textMuted;
    ctx.font = '500 10px JetBrains Mono, monospace';
    ctx.fillText(fmtDate(dates[idx]).replace(/, \d{4}/, ''), x, h - 8);
  }

  // Fill area
  ctx.beginPath();
  ctx.moveTo(xPos(0), yPos(values[0]));
  for (let i = 1; i < values.length; i++) {
    ctx.lineTo(xPos(i), yPos(values[i]));
  }
  ctx.lineTo(xPos(values.length - 1), pad.top + ch);
  ctx.lineTo(xPos(0), pad.top + ch);
  ctx.closePath();
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
  const lastVal = values[values.length - 1];
  const firstVal = values[0];
  const lineColor = lastVal >= firstVal ? accentGreen : accentPrimary;
  grad.addColorStop(0, lineColor + '30');
  grad.addColorStop(1, lineColor + '05');
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(xPos(0), yPos(values[0]));
  for (let i = 1; i < values.length; i++) {
    ctx.lineTo(xPos(i), yPos(values[i]));
  }
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 2.5;
  ctx.stroke();

  // End dot
  const lastX = xPos(values.length - 1);
  const lastY = yPos(lastVal);
  ctx.beginPath();
  ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
  ctx.fillStyle = lineColor;
  ctx.fill();
  ctx.strokeStyle = textPrimary;
  ctx.lineWidth = 2;
  ctx.stroke();
}

/* ── Safety Rails ── */

function loadSafetyRails() {
  const cfg = state.config;
  const p = state.portfolio || {};
  const rails = [
    {
      label: 'Simulation Only',
      value: 'Paper trading',
      status: 'ok',
    },
    {
      label: 'Bankroll Ceiling',
      value: fmt$(cfg.max_bankroll || 0),
      status: 'ok',
    },
    {
      label: 'Position Cap',
      value: `${((cfg.position_cap_pct || 0.25) * 100).toFixed(0)}% of bankroll`,
      status: 'ok',
    },
    {
      label: 'Quarter-Kelly',
      value: `Fraction: ${cfg.kelly_fraction || 0.25}`,
      status: 'ok',
    },
    {
      label: 'Min Edge',
      value: `${((cfg.min_edge_threshold || 0.10) * 100).toFixed(0)}pp threshold`,
      status: 'ok',
    },
    {
      label: 'Daily Loss Limit',
      value: `-${((cfg.daily_loss_limit_pct || 0.05) * 100).toFixed(0)}%`,
      status: 'ok',
    },
    {
      label: 'Kill Switch',
      value: cfg.kill_switch ? 'ENGAGED' : 'Disengaged',
      status: cfg.kill_switch ? 'error' : 'ok',
    },
    {
      label: 'Log-Before-Execute',
      value: 'Active',
      status: 'ok',
    },
  ];

  const iconMap = { ok: '&#10003;', warn: '!', error: '&#10005;' };
  const grid = $('safetyGrid');
  grid.innerHTML = rails.map(r => `
    <div class="safety-item safety-${r.status}">
      <div class="safety-icon">${iconMap[r.status]}</div>
      <div>
        <div class="safety-text-label">${r.label}</div>
        <div class="safety-text-value">${r.value}</div>
      </div>
    </div>
  `).join('');
}

/* ── Recent Activity (Dashboard) ── */

async function loadRecentActivity() {
  try {
    const data = await api('GET', '/api/logs?since=0');
    const logs = (data.logs || []).slice(-8).reverse();
    const el = $('recentActivity');

    if (logs.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="empty-state-text">No recent activity</div></div>';
      return;
    }

    el.innerHTML = logs.map(l => {
      const level = (l.level || 'info').toLowerCase();
      const colorMap = { info: 'var(--accent-cyan)', warning: 'var(--accent-gold)', error: 'var(--accent-danger)', debug: 'var(--text-muted)' };
      return `
        <div class="activity-item">
          <div class="activity-dot" style="background: ${colorMap[level] || colorMap.info};"></div>
          <div class="activity-text">${escHtml(l.event || '')}</div>
          <div class="activity-time">${fmtTime(l.timestamp)}</div>
        </div>
      `;
    }).join('');
  } catch (e) {
    console.error('Recent activity error:', e);
  }
}

/* ================================================================
   MARKETS TAB
   ================================================================ */

async function scanEvents() {
  const overlay = $('scanOverlay');
  overlay.classList.add('active');
  $('scanOverlayText').textContent = 'Scanning weather markets...';

  try {
    const data = await api('POST', '/api/events/scan');
    state.events = data.events || [];
    state.signals = data.signals || [];
    state.betSlipSelections.clear();
    updateBetSlipUI();

    renderEvents();
    toast(`Found ${state.events.length} event(s) with ${state.signals.length} signal(s)`, 'success');
  } catch (e) {
    toast('Scan failed: ' + e.message, 'error');

    // Fallback to legacy scan
    try {
      $('scanOverlayText').textContent = 'Trying legacy scan...';
      const legacy = await api('POST', '/api/scan');
      renderLegacySignals(legacy.signals || []);
      toast(`Legacy scan: ${(legacy.signals || []).length} signal(s)`, 'info');
    } catch (e2) {
      toast('Legacy scan also failed: ' + e2.message, 'error');
    }
  } finally {
    overlay.classList.remove('active');
  }
}

function renderEvents() {
  const container = $('marketsContent');

  // Flatten signals into a single list of actionable bets
  const bets = state.signals.filter(s =>
    Math.abs(Number(s.edge || 0)) >= (Number(state.config.min_edge_threshold) || 0.10)
  );

  if (bets.length === 0 && state.events.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">&#127780;</div>
        <div class="empty-state-text">No weather events found</div>
      </div>
    `;
    return;
  }

  if (bets.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">&#9989;</div>
        <div class="empty-state-text">Scanned ${state.events.length} event(s) — no mispriced bets found right now</div>
      </div>
    `;
    return;
  }

  // Build event lookup for context
  const eventLookup = {};
  for (const e of state.events) { eventLookup[e.event_id] = e; }

  // Sort by absolute edge descending (best bets first)
  bets.sort((a, b) => Math.abs(Number(b.edge || 0)) - Math.abs(Number(a.edge || 0)));

  const totalSize = bets.reduce((sum, s) => sum + Number(s.recommended_size || 0), 0);
  const totalProfit = bets.reduce((sum, s) => {
    const side = (s.side || (Number(s.edge || 0) > 0 ? 'YES' : 'NO')).toUpperCase();
    const mkt = Number(s.market_price || 0);
    const size = Number(s.recommended_size || 0);
    const buyPrice = side === 'YES' ? mkt : (1 - mkt);
    return sum + (buyPrice > 0 ? size * (1 - buyPrice) / buyPrice : 0);
  }, 0);

  container.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">${bets.length} Mispriced Bet${bets.length > 1 ? 's' : ''} Found</h3>
        <div style="display:flex; gap: var(--space-sm);">
          <span class="badge badge-pink">Stake: $${totalSize.toFixed(2)}</span>
          <span class="badge badge-green">If all win: +$${totalProfit.toFixed(2)}</span>
        </div>
      </div>
      <div style="overflow-x: auto;">
        <table class="bets-table">
          <thead>
            <tr>
              <th>Bet</th>
              <th>Location</th>
              <th>Date</th>
              <th>Side</th>
              <th class="num">NOAA</th>
              <th class="num">Market</th>
              <th class="num">Edge</th>
              <th class="num">Stake</th>
              <th class="num">If Win</th>
            </tr>
          </thead>
          <tbody>
            ${bets.map(s => {
              const ev = eventLookup[s.event_id] || {};
              const edge = Number(s.edge || 0);
              const edgeCls = edge > 0 ? 'text-green' : 'text-red';
              const side = (s.side || (edge > 0 ? 'YES' : 'NO')).toUpperCase();
              const sideCls = side === 'YES' ? 'badge-green' : 'badge-danger';
              const label = s.outcome_label || s.question || ev.question || s.market_id || '';
              const shortLabel = formatBetLabel(label, ev.metric);
              const noaa = Number(s.noaa_probability || 0);
              const mkt = Number(s.market_price || 0);
              const size = Number(s.recommended_size || 0);
              // Potential profit if bet wins
              const buyPrice = side === 'YES' ? mkt : (1 - mkt);
              const profit = buyPrice > 0 ? size * (1 - buyPrice) / buyPrice : 0;
              return `
                <tr>
                  <td><span class="bet-label" title="${escHtml(label)}">${escHtml(shortLabel)}</span></td>
                  <td>${escHtml(ev.location || s.location || '')}</td>
                  <td>${fmtDate(ev.event_date || s.event_date || '')}</td>
                  <td><span class="badge ${sideCls}">${side}</span></td>
                  <td class="num">${(noaa * 100).toFixed(0)}%</td>
                  <td class="num">${(mkt * 100).toFixed(0)}\u00A2</td>
                  <td class="num ${edgeCls}">${edge > 0 ? '+' : ''}${(edge * 100).toFixed(1)}pp</td>
                  <td class="num">$${size.toFixed(2)}</td>
                  <td class="num text-green">+$${profit.toFixed(2)}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
      <div style="padding: var(--space-md) var(--space-lg); border-top: var(--border-width) solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
        <div style="color: var(--text-secondary); font-size: var(--step--1);">
          Risk <strong>$${totalSize.toFixed(2)}</strong> to win up to <strong class="text-green">+$${totalProfit.toFixed(2)}</strong> across ${bets.length} bet${bets.length > 1 ? 's' : ''}
        </div>
        <button class="btn btn-primary btn-lg" onclick="executeAllBets()">
          Place All Bets ($${totalSize.toFixed(2)})
        </button>
      </div>
    </div>
  `;
}

function formatBetLabel(label, metric) {
  const unit = (metric || '').includes('precip') ? '"' : '\u00B0F';

  // "48-49" or "48 - 49" or "48–49"
  const rangeMatch = label.match(/(\d+\.?\d*)\s*[-–]\s*(\d+\.?\d*)/);
  if (rangeMatch) return `${rangeMatch[1]}\u2013${rangeMatch[2]}${unit}`;

  // "47°F or below", "47 degrees or lower", etc
  const belowMatch = label.match(/(\d+\.?\d*)\s*(?:°\s*F?\s*|degrees?\s*(?:F(?:ahrenheit)?)?\s*)?(?:or\s+)?(?:below|under|less|lower)/i);
  if (belowMatch) return `\u2264 ${belowMatch[1]}${unit}`;

  // "55°F or above", "55 degrees or more", etc
  const aboveMatch = label.match(/(\d+\.?\d*)\s*(?:°\s*F?\s*|degrees?\s*(?:F(?:ahrenheit)?)?\s*)?(?:or\s+)?(?:above|over|more|higher)/i);
  if (aboveMatch) return `\u2265 ${aboveMatch[1]}${unit}`;

  // Grab text after "be" — "Will the highest temp ... be 48-49 degrees"
  const afterBe = label.match(/\bbe\s+(.+)/i);
  if (afterBe) {
    const tail = afterBe[1].replace(/\s*\?$/, '').replace(/degrees?\s*(fahrenheit|f)?/gi, unit).trim();
    return tail.length > 25 ? tail.slice(0, 23) + '\u2026' : tail;
  }

  return label.length > 25 ? label.slice(0, 23) + '\u2026' : label;
}

function renderLegacySignals(signals) {
  const container = $('marketsContent');
  if (signals.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#127780;</div><div class="empty-state-text">No signals found (legacy scan)</div></div>';
    return;
  }

  container.innerHTML = `
    <div class="card" style="margin-bottom: var(--space-lg);">
      <div class="card-header">
        <h3 class="card-title">Legacy Binary Signals</h3>
        <span class="badge badge-gold">Legacy</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Market</th>
              <th>Side</th>
              <th>NOAA</th>
              <th>Market</th>
              <th>Edge</th>
              <th>Size</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody>
            ${signals.map(s => `
              <tr>
                <td style="font-family: var(--font-sans); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escHtml(s.question || s.market_id || '')}</td>
                <td><span class="badge ${s.side === 'YES' ? 'badge-green' : 'badge-red'}">${s.side}</span></td>
                <td>${fmtPct(s.noaa_probability)}</td>
                <td>${fmtPct(s.market_price)}</td>
                <td class="${Number(s.edge) > 0 ? 'text-green' : 'text-red'}">${fmtPctPts(s.edge)}</td>
                <td>${fmt$(s.recommended_size)}</td>
                <td><span class="badge badge-muted">${s.confidence}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

/* ================================================================
   BET SLIP
   ================================================================ */

function toggleBetSlipItem() { /* no-op, kept for compat */ }
function updateBetSlipUI() { /* no-op, kept for compat */ }

async function executeBetSlip() { await executeAllBets(); }

async function executeAllBets() {
  // Execute all signals the bot found — no manual selection needed
  const bets = state.signals.filter(s =>
    Math.abs(Number(s.edge || 0)) >= (Number(state.config.min_edge_threshold) || 0.10)
  );
  if (bets.length === 0) { toast('No bets to place', 'info'); return; }

  // Build selections: group by event_id → bucket_indices
  const byEvent = {};
  for (const s of bets) {
    if (!byEvent[s.event_id]) byEvent[s.event_id] = [];
    byEvent[s.event_id].push(s.bucket_index);
  }
  const selections = Object.entries(byEvent).map(([event_id, bucket_indices]) => ({ event_id, bucket_indices }));

  // Disable button
  const btn = document.querySelector('#marketsContent .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = 'Placing...'; }

  try {
    const data = await api('POST', '/api/events/execute', { selections });
    const trades = data.trades || [];
    toast(`Placed ${trades.length} paper bet(s)!`, 'success');

    if (data.skipped > 0) {
      const reasons = data.skip_reasons || [];
      const reasonTexts = reasons.map(r => typeof r === 'string' ? r : (r.reason || 'unknown'));
      const unique = [...new Set(reasonTexts)];
      toast(`Skipped ${data.skipped}: ${unique.join(', ') || 'limit reached'}`, 'info');
    }

    // Refresh
    loadStatus();
    scanEvents();
  } catch (e) {
    toast('Execution failed: ' + e.message, 'error');
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Place All Bets'; }
  }
}

/* ================================================================
   PORTFOLIO TAB
   ================================================================ */

async function loadPortfolio() {
  loadPortfolioSummary();
  loadOpenPositions();
  loadReadyPositions();
  loadResolvedTrades();
}

async function loadPortfolioSummary() {
  try {
    const data = await api('GET', '/api/portfolio');
    state.portfolio = data;

    const grid = $('portfolioMetrics');
    grid.innerHTML = `
      <div class="metric-card">
        <div class="metric-label">Available Bankroll</div>
        <div class="metric-value">${fmt$(data.available_bankroll)}</div>
        <div class="metric-sub">of ${fmt$(data.max_bankroll)} max</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Total Invested</div>
        <div class="metric-value text-cyan">${fmt$(data.total_invested)}</div>
        <div class="metric-sub">${data.open_positions || 0} positions</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Realized P&L</div>
        <div class="metric-value ${Number(data.realized_pnl) >= 0 ? 'text-green' : 'text-red'}">${fmt$(data.realized_pnl)}</div>
        <div class="metric-sub">${data.wins || 0}W / ${data.losses || 0}L</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Max Profit (est.)</div>
        <div class="metric-value text-green">${fmt$(data.estimated_max_profit || 0)}</div>
        <div class="metric-sub">If all open bets win</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Max Loss (est.)</div>
        <div class="metric-value text-red">${fmt$(data.estimated_max_loss || 0)}</div>
        <div class="metric-sub">If all open bets lose</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Expected P&L</div>
        <div class="metric-value ${Number(data.estimated_expected_pnl || 0) >= 0 ? 'text-green' : 'text-red'}">${fmt$(data.estimated_expected_pnl || 0)}</div>
        <div class="metric-sub">NOAA-weighted</div>
      </div>
    `;
  } catch (e) {
    console.error('Portfolio summary error:', e);
  }
}

async function loadOpenPositions() {
  const el = $('openPositions');
  try {
    const data = await api('GET', '/api/positions');
    const positions = data.positions || [];

    if (positions.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="empty-state-text">No open positions</div></div>';
      return;
    }

    el.innerHTML = `
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Market</th>
              <th>Side</th>
              <th>Price</th>
              <th>Size</th>
              <th>NOAA Prob</th>
              <th>Max Profit</th>
              <th>Max Loss</th>
              <th>Expected</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            ${positions.map(p => `
              <tr>
                <td style="font-family: var(--font-sans); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escHtml(p.question || p.market_id || '--')}</td>
                <td><span class="badge ${p.side === 'YES' ? 'badge-green' : 'badge-red'}">${p.side}</span></td>
                <td>${fmtPct(p.price)}</td>
                <td>${fmt$(p.size)}</td>
                <td>${p.noaa_probability ? fmtPct(p.noaa_probability) : '--'}</td>
                <td class="text-green">${fmt$(p.max_profit || 0)}</td>
                <td class="text-red">${fmt$(p.max_loss || 0)}</td>
                <td class="${Number(p.expected_pnl || 0) >= 0 ? 'text-green' : 'text-red'}">${fmt$(p.expected_pnl || 0)}</td>
                <td>${fmtDate(p.created_at || p.timestamp)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  } catch (e) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-text">Failed to load positions</div></div>';
  }
}

async function loadReadyPositions() {
  const el = $('readyPositions');
  try {
    const data = await api('GET', '/api/trades?status=ready&days=365');
    const trades = data.trades || [];

    if (trades.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="empty-state-text">No trades ready to resolve</div></div>';
      return;
    }

    el.innerHTML = `
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Market</th>
              <th>Side</th>
              <th>Price</th>
              <th>Size</th>
              <th>Traded</th>
            </tr>
          </thead>
          <tbody>
            ${trades.map(t => `
              <tr>
                <td style="font-family: var(--font-sans); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escHtml(t.question || t.market_id || '--')}</td>
                <td><span class="badge ${t.side === 'YES' ? 'badge-green' : 'badge-red'}">${t.side}</span></td>
                <td>${fmtPct(t.price)}</td>
                <td>${fmt$(t.size)}</td>
                <td>${fmtDate(t.created_at || t.timestamp)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  } catch (e) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-text">Failed to load ready trades</div></div>';
  }
}

async function loadResolvedTrades() {
  const el = $('resolvedTrades');
  try {
    const data = await api('GET', '/api/trades?status=resolved&days=365');
    const trades = data.trades || [];

    if (trades.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="empty-state-text">No resolved trades yet</div></div>';
      return;
    }

    el.innerHTML = `
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Market</th>
              <th>Side</th>
              <th>Price</th>
              <th>Size</th>
              <th>Outcome</th>
              <th>P&L</th>
              <th>Resolved</th>
            </tr>
          </thead>
          <tbody>
            ${trades.map(t => {
              const pnl = Number(t.pnl || 0);
              const won = t.outcome === 'win';
              return `
                <tr>
                  <td style="font-family: var(--font-sans); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escHtml(t.question || t.market_id || '--')}</td>
                  <td><span class="badge ${t.side === 'YES' ? 'badge-green' : 'badge-red'}">${t.side}</span></td>
                  <td>${fmtPct(t.price)}</td>
                  <td>${fmt$(t.size)}</td>
                  <td><span class="badge ${won ? 'badge-green' : 'badge-red'}">${t.outcome || '--'}</span></td>
                  <td class="${pnl >= 0 ? 'text-green' : 'text-red'}">${fmt$(pnl)}</td>
                  <td>${fmtDate(t.resolved_at)}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  } catch (e) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-text">Failed to load resolved trades</div></div>';
  }
}

async function resolveTrades() {
  try {
    toast('Resolving trades...', 'info');
    const data = await api('POST', '/api/resolve');
    const resolved = data.resolved || 0;
    toast(`Resolved ${resolved} trade(s)`, resolved > 0 ? 'success' : 'info');
    loadPortfolio();
    loadDashboard();
  } catch (e) {
    toast('Resolve failed: ' + e.message, 'error');
  }
}

/* ================================================================
   ACTIVITY LOG
   ================================================================ */

async function loadLogs() {
  try {
    const data = await api('GET', `/api/logs?since=${state.logCursor}`);
    const logs = data.logs || [];
    state.logCursor = data.cursor || state.logCursor;

    if (logs.length === 0 && state.logCursor === 0) return;

    const viewer = $('logViewer');

    // If this is the first load or refresh, clear
    if (logs.length > 0 && viewer.querySelector('.empty-state')) {
      viewer.innerHTML = '';
    }

    // Append new logs
    for (const l of logs) {
      const level = (l.level || 'info').toLowerCase();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-ts">${l.timestamp || ''}</span>
        <span class="log-level ${level}">${level}</span>
        <span class="log-msg">${escHtml(l.event || '')}${buildLogExtra(l)}</span>
      `;
      viewer.appendChild(entry);
    }

    // Auto-scroll to bottom
    if (logs.length > 0) {
      viewer.scrollTop = viewer.scrollHeight;
    }
  } catch (e) {
    console.error('Log fetch error:', e);
  }
}

function buildLogExtra(l) {
  const skip = new Set(['timestamp', 'level', 'event', 'id']);
  const extra = Object.entries(l).filter(([k]) => !skip.has(k));
  if (extra.length === 0) return '';
  return ' <span style="color: var(--text-muted);">' + extra.map(([k, v]) => `${k}=${v}`).join(' ') + '</span>';
}

function startLogPolling() {
  stopLogPolling();
  state.logPollTimer = setInterval(() => {
    if ($('logAutoPoll') && $('logAutoPoll').checked) {
      loadLogs();
    }
  }, 3000);
}

function stopLogPolling() {
  if (state.logPollTimer) {
    clearInterval(state.logPollTimer);
    state.logPollTimer = null;
  }
}

/* ================================================================
   SETTINGS
   ================================================================ */

async function loadSettings() {
  await loadStatus();
  const cfg = state.config;
  $('setMaxBankroll').value = cfg.max_bankroll || '';
  $('setPositionCap').value = cfg.position_cap_pct != null ? (cfg.position_cap_pct * 100) : '';
  $('setKellyFraction').value = cfg.kelly_fraction || '';
  $('setEdgeThreshold').value = cfg.min_edge_threshold != null ? (cfg.min_edge_threshold * 100) : '';
  $('setDailyLoss').value = cfg.daily_loss_limit_pct != null ? (cfg.daily_loss_limit_pct * 100) : '';
  $('setLogLevel').value = cfg.log_level || 'INFO';
}

async function saveSettings() {
  const body = {
    max_bankroll: parseFloat($('setMaxBankroll').value) || undefined,
    position_cap_pct: $('setPositionCap').value ? parseFloat($('setPositionCap').value) / 100 : undefined,
    kelly_fraction: parseFloat($('setKellyFraction').value) || undefined,
    min_edge_threshold: $('setEdgeThreshold').value ? parseFloat($('setEdgeThreshold').value) / 100 : undefined,
    daily_loss_limit_pct: $('setDailyLoss').value ? parseFloat($('setDailyLoss').value) / 100 : undefined,
    log_level: $('setLogLevel').value || undefined,
  };

  // Remove undefined keys
  Object.keys(body).forEach(k => body[k] === undefined && delete body[k]);

  try {
    const data = await api('PUT', '/api/settings', body);
    updateStatusUI(data);
    toast('Settings saved', 'success');
  } catch (e) {
    toast('Failed to save: ' + e.message, 'error');
  }
}

/* ================================================================
   INIT
   ================================================================ */

document.addEventListener('DOMContentLoaded', () => {
  loadDashboard();
});

// Resize equity curve on window resize
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    if (state.activeTab === 'dashboard') loadEquityCurve();
  }, 250);
});
</script>
</body>
</html>

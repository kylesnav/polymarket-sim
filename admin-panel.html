<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather Edge Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-root: #060710;
  --bg-card: #10111b;
  --bg-card-hover: #141521;
  --bg-input: #0d0e18;
  --border: #1a1c2e;
  --border-subtle: #131422;
  --text-1: #e8e8ec;
  --text-2: #8b8fa8;
  --text-3: #505370;
  --green: #00e68a;
  --green-bg: rgba(0,230,138,0.08);
  --green-border: rgba(0,230,138,0.2);
  --red: #ff475a;
  --red-bg: rgba(255,71,90,0.08);
  --red-border: rgba(255,71,90,0.2);
  --amber: #ffb800;
  --amber-bg: rgba(255,184,0,0.08);
  --amber-border: rgba(255,184,0,0.2);
  --blue: #4d8eff;
  --blue-bg: rgba(77,142,255,0.08);
  --blue-border: rgba(77,142,255,0.2);
  --font-display: 'Syne', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 10px;
  --radius-sm: 6px;
}

html { font-size: 14px; }
body {
  font-family: var(--font-mono);
  background: var(--bg-root);
  color: var(--text-1);
  min-height: 100vh;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 50% -20%, rgba(77,142,255,0.04), transparent),
    radial-gradient(ellipse 60% 40% at 80% 100%, rgba(0,230,138,0.03), transparent);
  pointer-events: none;
}

.dashboard { position: relative; z-index: 1; padding: 0 24px 48px; max-width: 1520px; margin: 0 auto; }

/* ── Topbar ── */
.topbar {
  display: flex; align-items: center; gap: 20px; padding: 16px 0;
  border-bottom: 1px solid var(--border); margin-bottom: 0;
  position: sticky; top: 0; z-index: 100; background: var(--bg-root);
}
.topbar::after {
  content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--blue), var(--green), transparent); opacity: 0.3;
}
.bot-name {
  font-family: var(--font-display); font-weight: 800; font-size: 1.3rem; letter-spacing: -0.02em;
  color: var(--text-1);
}
.status-badge {
  display: flex; align-items: center; gap: 6px; font-size: 0.75rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.08em; padding: 4px 10px; border-radius: 20px;
  background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border);
}
.status-badge.halted { background: var(--red-bg); color: var(--red); border-color: var(--red-border); }
.status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: pulse-dot 2s ease-in-out infinite; }
@keyframes pulse-dot { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
.topbar-spacer { flex: 1; }
.topbar-stat { display: flex; flex-direction: column; gap: 1px; }
.topbar-stat-label { font-size: 0.65rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.1em; }
.topbar-stat-value { font-size: 0.9rem; font-weight: 600; }
.topbar-stat-value.positive { color: var(--green); }
.topbar-stat-value.negative { color: var(--red); }
.topbar-divider { width: 1px; height: 32px; background: var(--border); }
.kill-switch-wrap { display: flex; align-items: center; gap: 10px; margin-left: 8px; }
.kill-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--red); opacity: 0.7; }
.kill-toggle { position: relative; width: 52px; height: 28px; cursor: pointer; }
.kill-toggle input { display: none; }
.kill-track { position: absolute; inset: 0; border-radius: 14px; background: var(--bg-card); border: 2px solid var(--border); transition: all 0.3s; }
.kill-knob { position: absolute; top: 4px; left: 4px; width: 20px; height: 20px; border-radius: 50%; background: var(--text-2); transition: all 0.3s; z-index: 1; }
.kill-toggle input:checked ~ .kill-track { background: var(--red); border-color: var(--red); box-shadow: 0 0 20px rgba(255,71,90,0.4); }
.kill-toggle input:checked ~ .kill-knob { left: 28px; background: #fff; }

/* ── Tab Navigation ── */
.tab-nav {
  display: flex; gap: 4px; padding: 12px 0; border-bottom: 1px solid var(--border);
  margin-bottom: 20px; overflow-x: auto; position: sticky; top: 56px; z-index: 99;
  background: var(--bg-root);
}
.tab-btn {
  padding: 8px 16px; border-radius: var(--radius-sm); border: 1px solid transparent;
  background: transparent; color: var(--text-3); font-family: var(--font-mono);
  font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
  white-space: nowrap;
}
.tab-btn:hover { color: var(--text-2); background: var(--bg-card); }
.tab-btn.active { background: var(--blue-bg); border-color: var(--blue-border); color: var(--blue); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ── Tooltip ── */
.tip {
  display: inline-flex; align-items: center; justify-content: center;
  width: 16px; height: 16px; border-radius: 50%; margin-left: 4px;
  background: var(--bg-input); border: 1px solid var(--border);
  color: var(--text-3); font-size: 0.58rem; cursor: help;
  position: relative; vertical-align: middle; font-weight: 700;
}
.tip:hover::after {
  content: attr(data-tip);
  position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 14px;
  font-size: 0.72rem; font-weight: 400; color: var(--text-2); width: 260px;
  white-space: normal; z-index: 200; pointer-events: none;
  line-height: 1.5; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}

/* ── Section ── */
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.section-title {
  font-family: var(--font-display); font-weight: 700; font-size: 1rem; letter-spacing: -0.01em;
  color: var(--text-1); display: flex; align-items: center; gap: 10px;
}
.section-title::before { content: ''; width: 3px; height: 16px; border-radius: 2px; background: var(--blue); }
.section-controls { display: flex; gap: 6px; }
.pill-btn {
  padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border); background: transparent;
  color: var(--text-2); font-family: var(--font-mono); font-size: 0.7rem; font-weight: 500;
  cursor: pointer; transition: all 0.2s;
}
.pill-btn:hover { border-color: var(--text-3); color: var(--text-1); }
.pill-btn.active { background: var(--blue-bg); border-color: var(--blue-border); color: var(--blue); }
.tab-description { color: var(--text-2); font-size: 0.82rem; line-height: 1.6; margin-bottom: 20px; }

/* ── Cards ── */
.cards-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
.card {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 18px 20px; position: relative; overflow: hidden; cursor: default;
  transition: border-color 0.2s;
}
.card:hover { border-color: var(--border); }
.card.clickable { cursor: pointer; }
.card.clickable:hover { border-color: var(--amber-border); background: var(--bg-card-hover); }
.card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; opacity: 0.6; }
.card.accent-green::before { background: linear-gradient(90deg, var(--green), transparent); }
.card.accent-amber::before { background: linear-gradient(90deg, var(--amber), transparent); }
.card.accent-blue::before { background: linear-gradient(90deg, var(--blue), transparent); }
.card.accent-pnl::before { background: linear-gradient(90deg, var(--green), var(--blue), transparent); }
.card-label { font-size: 0.7rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
.card-value { font-size: 1.6rem; font-weight: 700; letter-spacing: -0.02em; line-height: 1; }
.card-value.positive { color: var(--green); }
.card-value.negative { color: var(--red); }
.card-sub { font-size: 0.75rem; color: var(--text-2); margin-top: 4px; }

/* ── Next Steps Banner ── */
.next-steps {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 16px 24px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px;
  font-size: 0.85rem; line-height: 1.5;
}
.next-steps-icon { font-size: 1.4rem; flex-shrink: 0; }
.next-steps-text { flex: 1; color: var(--text-2); }
.next-steps-text strong { color: var(--text-1); }
.next-steps .action-btn { flex-shrink: 0; font-size: 0.75rem; padding: 6px 16px; }

/* ── Chart ── */
.chart-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; }
.chart-wrap { position: relative; height: 240px; margin-top: 10px; }
.chart-wrap canvas { width: 100%; height: 100%; }
.chart-tooltip { position: absolute; background: #1a1c2e; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 12px; font-size: 0.75rem; pointer-events: none; opacity: 0; transition: opacity 0.15s; z-index: 10; white-space: nowrap; }
.chart-tooltip.visible { opacity: 1; }
.chart-crosshair { position: absolute; top: 0; width: 1px; height: 100%; background: rgba(77,142,255,0.2); pointer-events: none; opacity: 0; transition: opacity 0.15s; }
.chart-crosshair.visible { opacity: 1; }

/* ── Action ── */
.action-bar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
.action-btn {
  padding: 8px 20px; border-radius: var(--radius-sm); border: 1px solid var(--border);
  background: var(--bg-card); color: var(--text-1); font-family: var(--font-mono);
  font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; gap: 8px;
}
.action-btn:hover { border-color: var(--blue); background: var(--bg-card-hover); }
.action-btn.loading, .action-btn:disabled { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
.action-btn.loading::after {
  content: ''; width: 12px; height: 12px; border: 2px solid var(--text-3);
  border-top-color: var(--blue); border-radius: 50%; animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.action-btn.primary { border-color: var(--blue-border); background: var(--blue-bg); color: var(--blue); }
.action-btn.primary:hover { background: rgba(77,142,255,0.15); }
.action-btn.amber { border-color: var(--amber-border); background: var(--amber-bg); color: var(--amber); }
.action-btn.amber:hover { background: rgba(255,184,0,0.15); }
.action-output {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 14px 20px; margin-bottom: 20px; font-size: 0.8rem; line-height: 1.6;
  color: var(--text-2); display: none; white-space: pre-wrap;
}
.action-output.visible { display: block; }
.action-output .success { color: var(--green); }
.action-output .error { color: var(--red); }
.action-output .info { color: var(--blue); }

/* ── Tables ── */
.table-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
thead th { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-3); text-align: left; padding: 0 12px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; font-weight: 600; }
thead th:last-child { text-align: right; }
tbody td { padding: 10px 12px; font-size: 0.8rem; border-bottom: 1px solid var(--border-subtle); white-space: nowrap; color: var(--text-2); }
tbody td:last-child { text-align: right; }
tbody tr { transition: background 0.15s; cursor: pointer; }
tbody tr:hover { background: rgba(77,142,255,0.03); }
tbody tr:last-child td { border-bottom: none; }
.empty-row td { text-align: center !important; color: var(--text-3); padding: 24px 12px; cursor: default; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.68rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }
.badge-yes { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.badge-no { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }
.badge-open { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.badge-ready { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-border); }
.badge-resolved { background: var(--blue-bg); color: var(--blue); border: 1px solid var(--blue-border); }
.badge-won { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.badge-lost { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }
.edge-strong { color: var(--green); font-weight: 600; }
.edge-marginal { color: var(--amber); font-weight: 600; }
.val-pos { color: var(--green); }
.val-neg { color: var(--red); }
.table-filters { display: flex; gap: 10px; margin-bottom: 14px; align-items: center; }
.filter-select {
  padding: 6px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border);
  background: var(--bg-input); color: var(--text-2); font-family: var(--font-mono); font-size: 0.75rem;
  cursor: pointer; appearance: none; padding-right: 28px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23505370'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
}
.filter-select:focus { outline: none; border-color: var(--blue); }
.pagination { display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 14px; }
.page-btn { width: 30px; height: 30px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: transparent; color: var(--text-2); font-family: var(--font-mono); font-size: 0.75rem; cursor: pointer; display: grid; place-items: center; transition: all 0.2s; }
.page-btn:hover { border-color: var(--text-3); color: var(--text-1); }
.page-btn.active { background: var(--blue-bg); border-color: var(--blue-border); color: var(--blue); }
.page-info { font-size: 0.7rem; color: var(--text-3); }

/* ── Report Stats ── */
.report-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
.report-stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 18px; }
.report-stat-label { font-size: 0.65rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 6px; }
.report-stat-value { font-size: 1.1rem; font-weight: 700; }

/* ── Risk ── */
.risk-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 20px; }
.risk-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
.risk-card-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-3); margin-bottom: 16px; font-weight: 600; }
.gauge-wrap { display: flex; justify-content: center; align-items: center; position: relative; }
.gauge-wrap svg { overflow: visible; }
.gauge-center { position: absolute; text-align: center; }
.gauge-value { font-size: 1.4rem; font-weight: 700; display: block; }
.gauge-label { font-size: 0.65rem; color: var(--text-3); display: block; margin-top: 2px; }
.bar-group { display: flex; flex-direction: column; gap: 12px; }
.bar-item-label { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; margin-bottom: 4px; }
.bar-item-label span:first-child { color: var(--text-2); }
.bar-item-label span:last-child { color: var(--text-1); font-weight: 600; }

/* ── Modal ── */
.modal-overlay { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; width: 520px; max-width: 92vw; max-height: 80vh; overflow-y: auto; padding: 28px; transform: translateY(20px); transition: transform 0.25s; }
.modal-overlay.open .modal { transform: translateY(0); }
.modal-close { position: absolute; top: 16px; right: 16px; width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-3); font-size: 1rem; cursor: pointer; display: grid; place-items: center; transition: all 0.2s; }
.modal-close:hover { color: var(--text-1); border-color: var(--text-3); }
.modal-title { font-family: var(--font-display); font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; padding-right: 40px; }
.modal-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-subtle); font-size: 0.82rem; }
.modal-row:last-child { border-bottom: none; }
.modal-row-label { color: var(--text-3); }
.modal-row-value { color: var(--text-1); font-weight: 500; text-align: right; }
.modal-section-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-3); margin: 16px 0 8px; font-weight: 600; }

/* ── Lifecycle Section Headers ── */
.lifecycle-section { margin-bottom: 24px; }
.lifecycle-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
.lifecycle-header h3 { font-family: var(--font-display); font-weight: 700; font-size: 0.95rem; }
.lifecycle-count { font-size: 0.72rem; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
.lifecycle-header.open h3 { color: var(--green); }
.lifecycle-header.open .lifecycle-count { background: var(--green-bg); color: var(--green); }
.lifecycle-header.ready h3 { color: var(--amber); }
.lifecycle-header.ready .lifecycle-count { background: var(--amber-bg); color: var(--amber); }
.lifecycle-header.resolved h3 { color: var(--blue); }
.lifecycle-header.resolved .lifecycle-count { background: var(--blue-bg); color: var(--blue); }
.lifecycle-empty { color: var(--text-3); font-size: 0.8rem; padding: 12px 0; }

/* ── Bet Cards ── */
.bet-card {
  background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 14px 18px; margin-bottom: 8px; display: flex; align-items: center; gap: 16px;
  cursor: pointer; transition: all 0.15s;
}
.bet-card:hover { border-color: var(--blue-border); background: var(--bg-card-hover); }
.bet-card-main { flex: 1; min-width: 0; }
.bet-card-desc { font-size: 0.82rem; color: var(--text-1); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bet-card-meta { font-size: 0.72rem; color: var(--text-3); display: flex; gap: 12px; flex-wrap: wrap; }
.bet-card-money { text-align: right; flex-shrink: 0; }
.bet-card-stake { font-size: 0.85rem; font-weight: 600; color: var(--text-1); }
.bet-card-payout { font-size: 0.72rem; color: var(--green); margin-top: 2px; }
.bet-card-pnl { font-size: 0.85rem; font-weight: 600; }
.bet-card-countdown { font-size: 0.72rem; padding: 2px 8px; border-radius: 10px; flex-shrink: 0; font-weight: 500; }
.countdown-future { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.countdown-ready { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-border); }

/* ── Onboarding ── */
.onboarding { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 32px; margin-bottom: 24px; }
.onboarding h2 { font-family: var(--font-display); font-weight: 800; font-size: 1.4rem; margin-bottom: 12px; }
.onboarding p { color: var(--text-2); line-height: 1.7; margin-bottom: 24px; font-size: 0.85rem; }
.onboarding-steps { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.step-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
.step-num { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: var(--blue-bg); color: var(--blue); font-weight: 700; font-size: 0.85rem; margin-bottom: 10px; border: 1px solid var(--blue-border); }
.step-card h3 { font-family: var(--font-display); font-weight: 700; font-size: 0.95rem; margin-bottom: 6px; }
.step-card p { color: var(--text-2); font-size: 0.78rem; line-height: 1.6; margin-bottom: 12px; }
.step-card .action-btn { font-size: 0.72rem; padding: 6px 14px; }

/* ── Settings Tab ── */
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.form-group { margin-bottom: 18px; }
.form-label { display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-3); margin-bottom: 6px; font-weight: 600; }
.form-input { width: 100%; padding: 10px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg-input); color: var(--text-1); font-family: var(--font-mono); font-size: 0.85rem; transition: border-color 0.2s; }
.form-input:focus { outline: none; border-color: var(--blue); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-hint { font-size: 0.65rem; color: var(--text-3); margin-top: 4px; }
.modal-kill-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-top: 1px solid var(--border); margin-top: 8px; }
.modal-kill-label { font-size: 0.85rem; color: var(--red); font-weight: 600; }
.save-btn { width: 100%; padding: 12px; border-radius: var(--radius-sm); border: none; background: linear-gradient(135deg, var(--blue), #2563eb); color: #fff; font-family: var(--font-mono); font-size: 0.85rem; font-weight: 600; cursor: pointer; margin-top: 8px; transition: all 0.2s; }
.save-btn:hover { filter: brightness(1.1); }

/* ── Activity Log ── */
.log-viewer { background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; max-height: 500px; overflow-y: auto; font-size: 0.78rem; line-height: 1.8; }
.log-entry { display: flex; gap: 10px; padding: 2px 0; border-bottom: 1px solid var(--border-subtle); }
.log-entry:last-child { border-bottom: none; }
.log-time { color: var(--text-3); min-width: 80px; }
.log-level { min-width: 60px; font-weight: 600; text-transform: uppercase; font-size: 0.68rem; }
.log-level.info { color: var(--blue); }
.log-level.warning { color: var(--amber); }
.log-level.error { color: var(--red); }
.log-level.debug { color: var(--text-3); }
.log-msg { color: var(--text-2); }
.log-extra { color: var(--text-3); font-size: 0.7rem; }

/* ── Caveat Banner ── */
.caveat-banner { background: var(--amber-bg); border: 1px solid var(--amber-border); border-radius: var(--radius); padding: 14px 20px; margin-bottom: 20px; font-size: 0.8rem; color: var(--amber); line-height: 1.6; }

/* ── How It Works ── */
.how-section { margin-bottom: 32px; }
.how-section h3 { font-family: var(--font-display); font-weight: 700; font-size: 1.1rem; margin-bottom: 12px; color: var(--text-1); }
.how-section p { color: var(--text-2); font-size: 0.82rem; line-height: 1.7; margin-bottom: 10px; }
.flow-diagram { display: flex; align-items: stretch; gap: 0; margin: 24px 0; overflow-x: auto; padding-bottom: 8px; }
.flow-step { flex: 1; min-width: 160px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; text-align: center; }
.flow-icon { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background: var(--blue-bg); color: var(--blue); font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; border: 1px solid var(--blue-border); }
.flow-label { font-family: var(--font-display); font-weight: 700; font-size: 0.85rem; margin-bottom: 6px; }
.flow-detail { color: var(--text-3); font-size: 0.72rem; line-height: 1.5; }
.flow-arrow { display: flex; align-items: center; color: var(--text-3); font-size: 1.2rem; padding: 0 6px; }
.glossary-table { width: 100%; }
.glossary-table td { padding: 10px 14px; vertical-align: top; }
.glossary-table td:first-child { color: var(--blue); font-weight: 600; width: 180px; white-space: nowrap; }
.glossary-table td:last-child { color: var(--text-2); line-height: 1.6; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<div class="dashboard">

  <!-- ═══ SIM BANNER ═══ -->
  <div style="background:linear-gradient(90deg,rgba(77,142,255,0.12),rgba(0,230,138,0.08));border:1px solid var(--blue-border);border-radius:var(--radius);padding:10px 20px;margin-bottom:0;display:flex;align-items:center;gap:10px;font-size:0.78rem;color:var(--blue)">
    <span style="font-size:1.1rem">&#9888;</span>
    <span><strong>PAPER SIMULATION</strong> — No real funds at risk. All bets use simulated money.</span>
  </div>

  <!-- ═══ TOP BAR ═══ -->
  <header class="topbar">
    <div class="bot-name">Weather Edge Tracker</div>
    <div class="status-badge" id="statusBadge">
      <span class="status-dot"></span>
      <span id="statusText">Paper Sim</span>
    </div>
    <div class="topbar-spacer"></div>
    <div class="topbar-stat">
      <span class="topbar-stat-label">Portfolio</span>
      <span class="topbar-stat-value" id="topBankroll">--</span>
      <span class="topbar-stat-label" id="topCashExposure" style="margin-top:1px"></span>
    </div>
    <div class="topbar-divider"></div>
    <div class="topbar-stat">
      <span class="topbar-stat-label">Bets</span>
      <span class="topbar-stat-value" id="topBets">--</span>
    </div>
    <div class="topbar-divider"></div>
    <div class="kill-switch-wrap">
      <span class="kill-label">Kill</span>
      <label class="kill-toggle">
        <input type="checkbox" id="killSwitch">
        <span class="kill-track"></span>
        <span class="kill-knob"></span>
      </label>
    </div>
  </header>

  <!-- ═══ TAB NAVIGATION ═══ -->
  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
    <button class="tab-btn" data-tab="scan">Scan Markets</button>
    <button class="tab-btn" data-tab="simulate">Find &amp; Place Bets</button>
    <button class="tab-btn" data-tab="history">My Bets</button>
    <button class="tab-btn" data-tab="positions">Positions &amp; P&amp;L</button>
    <button class="tab-btn" data-tab="logs">Activity Log</button>
    <button class="tab-btn" data-tab="settings">Settings</button>
    <button class="tab-btn" data-tab="how">How It Works</button>
  </nav>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- TAB: DASHBOARD                                      -->
  <!-- ═══════════════════════════════════════════════════ -->
  <div class="tab-content active" id="tab-dashboard">

    <!-- Onboarding (shown when no data) -->
    <div class="onboarding" id="onboarding">
      <h2>Welcome to Weather Edge Tracker</h2>
      <p>This tool finds mispriced weather prediction contracts on Polymarket by comparing market prices against free NOAA government weather forecasts. It runs in simulation mode &mdash; tracking practice bets with fake money to prove the strategy works before risking real dollars.</p>
      <div class="onboarding-steps">
        <div class="step-card">
          <div class="step-num">1</div>
          <h3>Scan for Opportunities</h3>
          <p>The bot checks Polymarket for weather contracts (temperature, rain, snow) and pulls NOAA forecasts for the same events to find gaps.</p>
          <button class="action-btn primary" onclick="switchTab('scan')">Go to Scan</button>
        </div>
        <div class="step-card">
          <div class="step-num">2</div>
          <h3>Place Practice Bets</h3>
          <p>When the bot finds a gap between NOAA's forecast and the market price, it places a practice bet with fake money to track performance.</p>
          <button class="action-btn primary" onclick="switchTab('simulate')">Find &amp; Place Bets</button>
        </div>
        <div class="step-card">
          <div class="step-num">3</div>
          <h3>Review Results</h3>
          <p>After weather events happen, resolve your bets to see if they won. Track profit/loss over time to prove the strategy works.</p>
          <button class="action-btn primary" onclick="switchTab('history')">My Bets</button>
        </div>
      </div>
    </div>

    <!-- Dashboard content (shown when data exists) -->
    <div id="dashboardContent">
      <div class="cards-row">
        <div class="card accent-green">
          <div class="card-label">Open Bets <span class="tip" data-tip="Bets that have been placed but the weather event hasn't happened yet. Waiting for the outcome.">?</span></div>
          <div class="card-value" id="cardOpen">--</div>
          <div class="card-sub" id="cardOpenSub">awaiting weather</div>
        </div>
        <div class="card accent-amber clickable" id="cardReadyWrap" onclick="doResolveFromDashboard()">
          <div class="card-label">Ready to Resolve <span class="tip" data-tip="The weather event already happened for these bets. Click to check outcomes and calculate real P&L.">?</span></div>
          <div class="card-value" id="cardReady">--</div>
          <div class="card-sub" style="color:var(--amber)">click to resolve</div>
        </div>
        <div class="card accent-blue">
          <div class="card-label">Resolved <span class="tip" data-tip="Bets that have been settled. We know if they won or lost.">?</span></div>
          <div class="card-value" id="cardResolved">--</div>
          <div class="card-sub" id="cardResolvedSub"></div>
        </div>
        <div class="card accent-pnl">
          <div class="card-label">Actual P&amp;L <span class="tip" data-tip="Real profit or loss from resolved bets. This is the number that matters.">?</span></div>
          <div class="card-value" id="cardActualPnl">--</div>
          <div class="card-sub" id="cardPnlSub"></div>
        </div>
      </div>

      <!-- Next Steps -->
      <div class="next-steps" id="nextSteps" style="display:none"></div>

      <!-- P&L Chart -->
      <div class="chart-section">
        <div class="section-header">
          <div class="section-title">Portfolio Value</div>
          <div class="section-controls">
            <button class="pill-btn" data-range="7">7d</button>
            <button class="pill-btn active" data-range="30">30d</button>
            <button class="pill-btn" data-range="60">60d</button>
          </div>
        </div>
        <div class="chart-wrap" id="chartWrap">
          <canvas id="plChart"></canvas>
          <div class="chart-crosshair" id="chartCrosshair"></div>
          <div class="chart-tooltip" id="chartTooltip"></div>
        </div>
      </div>

      <!-- Report Stats -->
      <div class="report-grid" id="reportGrid">
        <div class="report-stat">
          <div class="report-stat-label">Avg Edge <span class="tip" data-tip="Average gap between NOAA forecast and market price across all bets.">?</span></div>
          <div class="report-stat-value" id="reportAvgEdge">--</div>
        </div>
        <div class="report-stat">
          <div class="report-stat-label">Avg Bet Size</div>
          <div class="report-stat-value" id="reportAvgSize">--</div>
        </div>
        <div class="report-stat">
          <div class="report-stat-label">Actual Wins / Losses</div>
          <div class="report-stat-value" id="reportActualWL">--</div>
        </div>
        <div class="report-stat">
          <div class="report-stat-label">Actual Win Rate</div>
          <div class="report-stat-value" id="reportActualWR">--</div>
        </div>
      </div>

      <!-- Risk Monitor -->
      <div class="risk-row">
        <div class="risk-card">
          <div class="risk-card-title">Configuration</div>
          <div class="bar-group" id="configBars"></div>
        </div>
        <div class="risk-card">
          <div class="risk-card-title">Daily Snapshot</div>
          <div class="gauge-wrap">
            <svg width="160" height="100" viewBox="0 0 160 100">
              <path d="M 20 90 A 60 60 0 0 1 140 90" fill="none" stroke="var(--border)" stroke-width="10" stroke-linecap="round"/>
              <path id="utilizationArc" d="M 20 90 A 60 60 0 0 1 140 90" fill="none" stroke="var(--blue)" stroke-width="10" stroke-linecap="round" stroke-dasharray="0 188.5"/>
            </svg>
            <div class="gauge-center">
              <span class="gauge-value" id="utilizationValue" style="color:var(--text-3)">--</span>
              <span class="gauge-label" id="utilizationLabel">trades today</span>
            </div>
          </div>
        </div>
        <div class="risk-card">
          <div class="risk-card-title">Safety Rails</div>
          <div id="safetyStatus" style="font-size:0.8rem;color:var(--text-2);line-height:1.8"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- TAB: SCAN MARKETS                                   -->
  <!-- ═══════════════════════════════════════════════════ -->
  <div class="tab-content" id="tab-scan">
    <div class="section-header">
      <div class="section-title">Scan Markets</div>
    </div>
    <p class="tab-description">Scan Polymarket for active weather contracts and compare prices against NOAA forecasts. No bets are placed &mdash; this just finds opportunities.</p>
    <div class="action-bar">
      <button class="action-btn primary" id="scanBtn">Scan Markets</button>
    </div>
    <div class="action-output" id="scanOutput"></div>
    <div id="scanLastTime" style="font-size:0.7rem;color:var(--text-3);margin-bottom:14px"></div>

    <div class="table-section" id="signalsSection" style="display:none">
      <div class="section-header">
        <div class="section-title">Opportunities Found</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>The Bet</th>
            <th>NOAA Says</th>
            <th>Market Says</th>
            <th>Our Edge</th>
            <th>Position</th>
            <th>Risk &amp; Reward</th>
          </tr>
        </thead>
        <tbody id="signalsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- TAB: SIMULATE                                       -->
  <!-- ═══════════════════════════════════════════════════ -->
  <div class="tab-content" id="tab-simulate">
    <div class="section-header">
      <div class="section-title">Find &amp; Place Bets</div>
    </div>
    <p class="tab-description">Scan for weather markets where NOAA disagrees with the crowd. Review opportunities, select which to bet on, then confirm.</p>
    <div class="action-bar">
      <button class="action-btn primary" id="simFindBtn">Find Opportunities</button>
      <button class="action-btn amber" id="resolveBtn">Resolve Past Bets</button>
      <span class="tip" data-tip="Checks actual weather outcomes for past bets and marks them as won or lost with real P&L.">?</span>
    </div>
    <div class="action-output" id="simOutput"></div>

    <div class="table-section" id="simSignalsSection" style="display:none">
      <div class="section-header">
        <div class="section-title">Opportunities Found</div>
        <div class="section-controls">
          <button class="pill-btn" id="selectAllBtn">Select All</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:32px"><input type="checkbox" id="checkAll"></th>
            <th>The Bet</th>
            <th>NOAA Says</th>
            <th>Market Says</th>
            <th>Our Edge</th>
            <th>Position</th>
            <th>Risk &amp; Reward</th>
          </tr>
        </thead>
        <tbody id="simSignalsBody"></tbody>
      </table>
    </div>

    <!-- Bet Slip -->
    <div id="betSlip" style="display:none;position:sticky;bottom:0;z-index:50;background:var(--bg-card);border:1px solid var(--green-border);border-radius:var(--radius);padding:14px 20px;margin-top:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:16px">
        <div style="font-size:0.85rem;color:var(--text-1)">
          <strong id="slipCount">0</strong> bet(s) selected &mdash; <strong id="slipTotal">$0.00</strong> total wagered
        </div>
        <button class="action-btn primary" id="placeBetsBtn" style="font-size:0.85rem;padding:10px 24px">Place Bets</button>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- TAB: MY BETS                                        -->
  <!-- ═══════════════════════════════════════════════════ -->
  <div class="tab-content" id="tab-history">
    <div class="section-header">
      <div class="section-title">My Bets</div>
      <div class="section-controls">
        <select class="filter-select" id="filterStatus">
          <option value="">All Bets</option>
          <option value="open">Open</option>
          <option value="ready">Ready to Resolve</option>
          <option value="resolved">Resolved</option>
        </select>
      </div>
    </div>
    <p class="tab-description">Every bet you've placed. Open bets are waiting for weather. Ready bets can be resolved now. Resolved bets show your actual profit or loss.</p>

    <div id="historyLifecycle"></div>
  </div>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- TAB: POSITIONS & P&L                                -->
  <!-- ═══════════════════════════════════════════════════ -->
  <div class="tab-content" id="tab-positions">
    <div class="section-header">
      <div class="section-title">Positions &amp; P&amp;L</div>
      <div class="section-controls">
        <button class="action-btn" onclick="loadPositions()">Refresh</button>
      </div>
    </div>
    <p class="tab-description">Estimated profit &amp; loss for all open positions. <strong>Expected P&amp;L</strong> is weighted by NOAA forecast probability. <strong>Max Profit</strong> assumes every bet wins.</p>

    <!-- Summary cards -->
    <div class="cards-row" id="posCards">
      <div class="card accent-green">
        <div class="card-label">Open Positions</div>
        <div class="card-value" id="posCount">--</div>
      </div>
      <div class="card accent-blue">
        <div class="card-label">Total Exposure</div>
        <div class="card-value" id="posExposure">--</div>
      </div>
      <div class="card accent-pnl">
        <div class="card-label">Expected P&amp;L <span class="tip" data-tip="Probability-weighted estimate. Each position's P&L is weighted by the NOAA forecast probability of winning.">?</span></div>
        <div class="card-value" id="posExpectedPnl">--</div>
        <div class="card-sub" id="posExpectedReturn"></div>
      </div>
      <div class="card accent-green">
        <div class="card-label">Max Profit <span class="tip" data-tip="Best-case scenario: every open bet wins and pays out at $1.">?</span></div>
        <div class="card-value" id="posMaxProfit">--</div>
        <div class="card-sub" id="posMaxLoss"></div>
      </div>
    </div>

    <!-- Scenario bar -->
    <div class="table-section" id="posScenarioWrap" style="display:none">
      <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:10px;font-weight:600">P&amp;L Range</div>
      <div style="display:flex;align-items:center;gap:8px;font-size:0.78rem;margin-bottom:6px">
        <span style="color:var(--red);font-weight:600" id="scenarioLoss">--</span>
        <div style="flex:1;position:relative;height:24px;background:linear-gradient(90deg,var(--red-bg),var(--bg-input) 40%,var(--bg-input) 60%,var(--green-bg));border-radius:12px;border:1px solid var(--border);overflow:hidden">
          <div id="scenarioMarker" style="position:absolute;top:2px;bottom:2px;width:3px;border-radius:2px;background:var(--blue);transition:left 0.3s"></div>
        </div>
        <span style="color:var(--green);font-weight:600" id="scenarioProfit">--</span>
      </div>
      <div style="text-align:center;font-size:0.72rem;color:var(--text-2)" id="scenarioExpected"></div>
    </div>

    <!-- Positions table -->
    <div class="table-section">
      <table>
        <thead>
          <tr>
            <th>Market</th>
            <th>Side</th>
            <th>Stake</th>
            <th>Entry</th>
            <th>NOAA Prob</th>
            <th>Max Profit</th>
            <th>Max Loss</th>
            <th>Expected P&amp;L</th>
            <th>Event</th>
          </tr>
        </thead>
        <tbody id="posTableBody">
          <tr class="empty-row"><td colspan="9">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- TAB: ACTIVITY LOG                                   -->
  <!-- ═══════════════════════════════════════════════════ -->
  <div class="tab-content" id="tab-logs">
    <div class="section-header">
      <div class="section-title">Activity Log</div>
      <div class="section-controls">
        <select class="filter-select" id="logLevelFilter">
          <option value="">All Levels</option>
          <option value="info">Info</option>
          <option value="warning">Warning</option>
          <option value="error">Error</option>
        </select>
        <button class="pill-btn" id="clearLogsBtn">Clear</button>
        <button class="pill-btn active" id="autoScrollBtn">Auto-scroll</button>
      </div>
    </div>
    <p class="tab-description">Real-time log of bot activity.</p>
    <div class="log-viewer" id="logViewer">
      <div style="color:var(--text-3);text-align:center;padding:20px">Waiting for activity... Run a scan or simulation to see logs here.</div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- TAB: SETTINGS                                       -->
  <!-- ═══════════════════════════════════════════════════ -->
  <div class="tab-content" id="tab-settings">
    <div class="section-header">
      <div class="section-title">Settings</div>
    </div>
    <p class="tab-description">Configure bet sizing, safety limits, and trading rules. Changes take effect on the next scan.</p>

    <div class="settings-grid">
      <div>
        <div class="form-group">
          <label class="form-label">Max Bankroll ($) <span class="tip" data-tip="Total money available for bets.">?</span></label>
          <input class="form-input" type="number" id="cfgBankroll" step="50">
        </div>
        <div class="form-group">
          <label class="form-label">Position Cap (%) <span class="tip" data-tip="Maximum size of any single bet as % of bankroll. 5% on $500 = $25 max per bet.">?</span></label>
          <input class="form-input" type="number" id="cfgPositionCap" step="1">
          <div class="form-hint">As percentage (e.g. 5 = 5%)</div>
        </div>
        <div class="form-group">
          <label class="form-label">Kelly Fraction <span class="tip" data-tip="How aggressively to size bets. 0.25 = conservative quarter-Kelly.">?</span></label>
          <input class="form-input" type="number" id="cfgKelly" step="0.05">
          <div class="form-hint">0.25 = quarter-Kelly (recommended)</div>
        </div>
      </div>
      <div>
        <div class="form-group">
          <label class="form-label">Min Edge Threshold (%) <span class="tip" data-tip="Minimum gap required before betting. 10% = NOAA must disagree by at least 10 cents.">?</span></label>
          <input class="form-input" type="number" id="cfgMinEdge" step="1">
          <div class="form-hint">As percentage (e.g. 10 = 10%)</div>
        </div>
        <div class="form-group">
          <label class="form-label">Daily Loss Limit (%) <span class="tip" data-tip="Stop trading if losses hit this % of bankroll in a day.">?</span></label>
          <input class="form-input" type="number" id="cfgDailyLoss" step="1">
          <div class="form-hint">As percentage (e.g. 5 = 5%)</div>
        </div>
        <div class="form-group">
          <label class="form-label">Log Level</label>
          <select class="form-input" id="cfgLogLevel">
            <option>INFO</option>
            <option>DEBUG</option>
            <option>WARNING</option>
            <option>ERROR</option>
          </select>
        </div>
      </div>
    </div>

    <div class="modal-kill-row">
      <span class="modal-kill-label">Emergency Kill Switch <span class="tip" data-tip="Halts all bot activity instantly.">?</span></span>
      <label class="kill-toggle">
        <input type="checkbox" id="settingsKillSwitch">
        <span class="kill-track"></span>
        <span class="kill-knob"></span>
      </label>
    </div>
    <button class="save-btn" id="saveSettingsBtn">Save Configuration</button>
  </div>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- TAB: HOW IT WORKS                                   -->
  <!-- ═══════════════════════════════════════════════════ -->
  <div class="tab-content" id="tab-how">
    <div class="how-section">
      <h3>The Strategy</h3>
      <p>NOAA (National Oceanic and Atmospheric Administration) publishes free weather forecasts that are <strong style="color:var(--green)">85&ndash;90% accurate</strong> at 1&ndash;2 day horizons. Polymarket lets anyone bet on weather outcomes &mdash; but casual bettors often misprice these contracts compared to the freely available government data.</p>
      <p>This bot exploits that gap: it compares NOAA's probability estimate to the market price. When the difference is large enough (10%+ by default), it places a bet sized conservatively using the Kelly Criterion.</p>
    </div>

    <div class="how-section">
      <h3>Step by Step</h3>
      <div class="flow-diagram">
        <div class="flow-step"><div class="flow-icon">1</div><div class="flow-label">Find Weather Bets</div><div class="flow-detail">Scan Polymarket for temperature, rain, and snow contracts</div></div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step"><div class="flow-icon">2</div><div class="flow-label">Get NOAA Forecast</div><div class="flow-detail">Free government data for the same location and date</div></div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step"><div class="flow-icon">3</div><div class="flow-label">Compare Prices</div><div class="flow-detail">If NOAA says 70% but market charges 55&cent;, that's a 15% edge</div></div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step"><div class="flow-icon">4</div><div class="flow-label">Size the Bet</div><div class="flow-detail">Quarter-Kelly formula decides how much to wager</div></div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step"><div class="flow-icon">5</div><div class="flow-label">Track Results</div><div class="flow-detail">Wait for weather, check if we were right, calculate real P&amp;L</div></div>
      </div>
    </div>

    <div class="how-section">
      <h3>Bet Sizing: Quarter-Kelly</h3>
      <p>The <strong>Kelly Criterion</strong> determines optimal bet size based on your edge. We use only <strong>25% of what Kelly recommends</strong> to be extra cautious.</p>
      <p><strong>Example:</strong> NOAA says 70% chance of rain but the market prices it at 55%. That's a 15% edge. On a $500 bankroll, the formula might recommend a $12 bet. No single bet can exceed 5% of bankroll ($25).</p>
    </div>

    <div class="how-section">
      <h3>Safety Rules</h3>
      <p>These are enforced automatically and cannot be bypassed:</p>
      <table class="glossary-table">
        <tr><td style="color:var(--green)">Simulation Only</td><td>No real money is used until performance is proven over 60+ days.</td></tr>
        <tr><td style="color:var(--green)">Bankroll Cap</td><td>Total capital is capped. Adjustable in Settings.</td></tr>
        <tr><td style="color:var(--green)">5% Position Cap</td><td>No single bet exceeds 5% of bankroll.</td></tr>
        <tr><td style="color:var(--green)">Quarter-Kelly</td><td>Bet sizes are always 25% of optimal Kelly.</td></tr>
        <tr><td style="color:var(--green)">10% Min Edge</td><td>Won't bet unless NOAA disagrees with the market by at least 10%.</td></tr>
        <tr><td style="color:var(--green)">5% Daily Loss Limit</td><td>If losses hit 5% of bankroll in a day, all betting halts.</td></tr>
        <tr><td style="color:var(--green)">Log Before Execute</td><td>Every bet is logged before it's recorded as placed.</td></tr>
        <tr><td style="color:var(--red)">Kill Switch</td><td>Emergency stop that halts everything instantly.</td></tr>
      </table>
    </div>

    <div class="how-section">
      <h3>Glossary</h3>
      <table class="glossary-table">
        <tr><td>Bankroll</td><td>Total money available for bets.</td></tr>
        <tr><td>Edge</td><td>The gap between NOAA's forecast and the market price. A 15% edge means the market is 15 cents off from what the data says.</td></tr>
        <tr><td>Kelly Criterion</td><td>Math formula for optimal bet sizing. We use quarter-Kelly (25%) to be safe.</td></tr>
        <tr><td>Kill Switch</td><td>Emergency stop. When on, no scanning or betting happens.</td></tr>
        <tr><td>NOAA</td><td>National Oceanic and Atmospheric Administration. US government weather forecasts.</td></tr>
        <tr><td>Open Bet</td><td>A bet that's been placed but the weather event hasn't happened yet.</td></tr>
        <tr><td>P&amp;L</td><td>Profit and Loss. Positive = you made money.</td></tr>
        <tr><td>Polymarket</td><td>A prediction market where people bet on real-world events. Contracts pay $1 if the event happens.</td></tr>
        <tr><td>Ready to Resolve</td><td>The weather event happened. Click resolve to check if you won or lost.</td></tr>
        <tr><td>Resolve</td><td>Checking actual weather and marking bets as won or lost with real P&amp;L.</td></tr>
        <tr><td>Win Rate</td><td>Percentage of resolved bets that were correct. Above 55% with positive P&amp;L = working strategy.</td></tr>
      </table>
    </div>
  </div>

</div>

<!-- ═══ TRADE DETAIL MODAL ═══ -->
<div class="modal-overlay" id="tradeModal">
  <div class="modal" style="position:relative">
    <button class="modal-close" id="modalClose">&times;</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════
//  API
// ═══════════════════════════════════════

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  if (!res.ok) {
    let msg = res.statusText;
    try { const j = await res.json(); msg = j.error || msg; } catch {}
    throw new Error(msg);
  }
  return res.json();
}

// ═══════════════════════════════════════
//  STATE
// ═══════════════════════════════════════

let statusData = {};
let portfolioData = {};
let reportData = {};
let tradesData = [];
let snapshotsData = [];
let signalsData = [];
let simSignalsData = [];
let positionsData = { positions: [], summary: {} };
let currentRange = 30;
let logCursor = 0;
let logAutoScroll = true;
let logEntries = [];

// ═══════════════════════════════════════
//  TAB SWITCHING
// ═══════════════════════════════════════

function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
  const content = document.getElementById('tab-' + tabId);
  if (btn) btn.classList.add('active');
  if (content) content.classList.add('active');
  if (tabId === 'dashboard') drawChart();
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

// ═══════════════════════════════════════
//  HELPERS
// ═══════════════════════════════════════

function formatMetric(metric) {
  const map = { temperature_high: 'High Temp', temperature_low: 'Low Temp', precipitation: 'Precipitation', snowfall: 'Snowfall' };
  return map[metric] || metric;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  } catch { return dateStr; }
}

function formatThreshold(threshold, metric) {
  if (threshold == null) return '?';
  if (metric && (metric.startsWith('temperature') || metric === 'temperature_high' || metric === 'temperature_low')) {
    return threshold + '\u00b0F';
  }
  if (metric === 'precipitation' || metric === 'snowfall') return threshold + ' in';
  return String(threshold);
}

function makeBetDescription(s) {
  if (s.question && s.question.length > 10) return s.question;
  const loc = s.location || '?';
  const metric = formatMetric(s.metric || '');
  const threshold = formatThreshold(s.threshold, s.metric);
  const eventDate = s.event_date ? formatDate(s.event_date) : '';
  return `${loc} ${metric} ${s.comparison || 'above'} ${threshold}${eventDate ? ' on ' + eventDate : ''}`;
}

function countdownText(daysUntil) {
  if (daysUntil == null) return '';
  if (daysUntil > 1) return `resolves in ${daysUntil}d`;
  if (daysUntil === 1) return 'resolves tomorrow';
  if (daysUntil === 0) return 'resolves today';
  if (daysUntil === -1) return 'resolved yesterday';
  return `resolved ${Math.abs(daysUntil)}d ago`;
}

// ═══════════════════════════════════════
//  LOAD DATA
// ═══════════════════════════════════════

async function loadAll() {
  await Promise.all([loadStatus(), loadPortfolio(), loadReport(), loadTrades(), loadSnapshots(), loadPositions()]);
  renderReport(); // Re-render after snapshots are loaded (fixes race condition)
  updateOnboarding();
}

async function loadStatus() {
  try {
    statusData = await api('GET', '/api/status');
    renderStatus();
  } catch (e) { console.error('status load failed', e); }
}

async function loadPortfolio() {
  try {
    portfolioData = await api('GET', '/api/portfolio');
    renderPortfolio();
  } catch (e) { console.error('portfolio load failed', e); }
}

async function loadReport() {
  try {
    reportData = await api('GET', '/api/report?days=90');
    renderReport();
  } catch (e) { console.error('report load failed', e); }
}

async function loadTrades() {
  try {
    const data = await api('GET', '/api/trades?days=365');
    tradesData = data.trades || [];
    renderHistory();
  } catch (e) { console.error('trades load failed', e); }
}

async function loadSnapshots() {
  try {
    const data = await api('GET', '/api/snapshots?days=60');
    snapshotsData = data.snapshots || [];
    drawChart();
  } catch (e) { console.error('snapshots load failed', e); }
}

// ═══════════════════════════════════════
//  ONBOARDING
// ═══════════════════════════════════════

function updateOnboarding() {
  const hasData = tradesData.length > 0 || snapshotsData.length > 0;
  document.getElementById('onboarding').style.display = hasData ? 'none' : 'block';
  document.getElementById('dashboardContent').style.display = hasData ? 'block' : 'none';
}

// ═══════════════════════════════════════
//  RENDER STATUS
// ═══════════════════════════════════════

function renderStatus() {
  const s = statusData;
  const badge = document.getElementById('statusBadge');
  const text = document.getElementById('statusText');
  const kill = document.getElementById('killSwitch');
  const settingsKill = document.getElementById('settingsKillSwitch');

  if (s.kill_switch) {
    badge.classList.add('halted');
    text.textContent = 'Halted';
    kill.checked = true;
    settingsKill.checked = true;
  } else {
    badge.classList.remove('halted');
    text.textContent = 'Paper Sim';
    kill.checked = false;
    settingsKill.checked = false;
  }

  // Settings form — skip if user is editing
  const settingsGrid = document.querySelector('.settings-grid');
  const formHasFocus = settingsGrid && settingsGrid.contains(document.activeElement);
  if (!formHasFocus) {
    document.getElementById('cfgBankroll').value = s.max_bankroll || 500;
    document.getElementById('cfgPositionCap').value = ((s.position_cap_pct || 0.05) * 100).toFixed(0);
    document.getElementById('cfgKelly').value = s.kelly_fraction || 0.25;
    document.getElementById('cfgMinEdge').value = ((s.min_edge_threshold || 0.1) * 100).toFixed(0);
    document.getElementById('cfgDailyLoss').value = ((s.daily_loss_limit_pct || 0.05) * 100).toFixed(0);
    document.getElementById('cfgLogLevel').value = s.log_level || 'INFO';
  }

  // Config bars
  const bars = document.getElementById('configBars');
  bars.innerHTML = [
    { label: 'Max Bankroll', val: '$' + (s.max_bankroll || 0).toFixed(0) },
    { label: 'Position Cap', val: ((s.position_cap_pct || 0) * 100).toFixed(0) + '%' },
    { label: 'Kelly Fraction', val: (s.kelly_fraction || 0).toFixed(2) },
    { label: 'Min Edge', val: ((s.min_edge_threshold || 0) * 100).toFixed(0) + '%' },
    { label: 'Daily Loss Limit', val: ((s.daily_loss_limit_pct || 0) * 100).toFixed(0) + '%' },
  ].map(c => `<div class="bar-item-label"><span>${c.label}</span><span>${c.val}</span></div>`).join('');

  // Safety
  const safety = document.getElementById('safetyStatus');
  safety.innerHTML = `
    Kill Switch: <span style="color:var(${s.kill_switch ? '--red' : '--green'})">${s.kill_switch ? 'ENGAGED' : 'OFF'}</span><br>
    Log Level: <span style="color:var(--text-1)">${s.log_level}</span><br>
    Open Bets: <span style="color:var(--text-1)">${s.open_bets || 0}</span> |
    Ready: <span style="color:var(--amber)">${s.ready_to_resolve || 0}</span>
  `;
}

// ═══════════════════════════════════════
//  RENDER PORTFOLIO
// ═══════════════════════════════════════

function renderPortfolio() {
  const p = portfolioData;

  // Topbar
  const totalVal = p.total_value || p.starting_bankroll || 0;
  document.getElementById('topBankroll').textContent = '$' + totalVal.toFixed(0);
  const cash = p.cash || 0;
  const exposure = p.exposure || 0;
  document.getElementById('topCashExposure').textContent = `$${cash.toFixed(0)} free / $${exposure.toFixed(0)} at risk`;

  const openCount = p.open || 0;
  const readyCount = p.ready || 0;
  const betsEl = document.getElementById('topBets');
  const parts = [];
  if (openCount) parts.push(openCount + ' open');
  if (readyCount) parts.push(readyCount + ' ready');
  betsEl.textContent = parts.length ? parts.join(' / ') : '0';
  if (readyCount > 0) betsEl.style.color = 'var(--amber)';
  else betsEl.style.color = '';

  // Dashboard cards
  document.getElementById('cardOpen').textContent = openCount;
  document.getElementById('cardReady').textContent = readyCount;
  document.getElementById('cardResolved').textContent = p.resolved || 0;

  const actPnl = p.actual_pnl || 0;
  const actEl = document.getElementById('cardActualPnl');
  actEl.textContent = (actPnl >= 0 ? '+' : '') + '$' + actPnl.toFixed(2);
  actEl.className = 'card-value ' + (actPnl >= 0 ? 'positive' : 'negative');

  // Show expected P&L from open positions on the P&L card
  const expectedPnl = p.estimated_expected_pnl || 0;
  const pnlSub = document.getElementById('cardPnlSub');
  if (openCount > 0 && expectedPnl !== 0) {
    const sign = expectedPnl >= 0 ? '+' : '';
    pnlSub.innerHTML = `Open: <span style="color:${expectedPnl >= 0 ? 'var(--green)' : 'var(--red)'}">${sign}$${expectedPnl.toFixed(2)}</span> expected`;
  } else {
    pnlSub.textContent = '';
  }

  // Show expected P&L on the Open Bets card
  const openSub = document.getElementById('cardOpenSub');
  if (openCount > 0 && expectedPnl !== 0) {
    const sign = expectedPnl >= 0 ? '+' : '';
    openSub.innerHTML = `${sign}$${expectedPnl.toFixed(2)} expected P&amp;L`;
    openSub.style.color = expectedPnl >= 0 ? 'var(--green)' : 'var(--red)';
  } else {
    openSub.textContent = 'awaiting weather';
    openSub.style.color = '';
  }

  // Find earliest open event date for next steps
  renderNextSteps(openCount, readyCount, p.resolved || 0);
}

function renderNextSteps(openCount, readyCount, resolvedCount) {
  const el = document.getElementById('nextSteps');
  if (readyCount > 0) {
    el.style.display = 'flex';
    el.innerHTML = `
      <span class="next-steps-icon" style="color:var(--amber)">&#9888;</span>
      <span class="next-steps-text"><strong>${readyCount} bet${readyCount > 1 ? 's are' : ' is'} ready to resolve.</strong> The weather happened &mdash; click to check if you won.</span>
      <button class="action-btn amber" onclick="doResolveFromDashboard()">Resolve Now</button>
    `;
  } else if (openCount > 0) {
    const earliest = tradesData.filter(t => t.lifecycle === 'open' && t.event_date).sort((a, b) => a.event_date.localeCompare(b.event_date))[0];
    const dateStr = earliest ? earliest.event_date : 'soon';
    el.style.display = 'flex';
    el.innerHTML = `
      <span class="next-steps-icon" style="color:var(--green)">&#9203;</span>
      <span class="next-steps-text"><strong>${openCount} bet${openCount > 1 ? 's' : ''} open.</strong> Next weather event: ${dateStr}. Come back after to resolve.</span>
    `;
  } else if (resolvedCount > 0) {
    el.style.display = 'flex';
    el.innerHTML = `
      <span class="next-steps-icon" style="color:var(--blue)">&#10003;</span>
      <span class="next-steps-text"><strong>All bets settled.</strong> Find new opportunities to keep testing.</span>
      <button class="action-btn primary" onclick="switchTab('simulate')">Find &amp; Place Bets</button>
    `;
  } else {
    el.style.display = 'none';
  }
}

async function doResolveFromDashboard() {
  const btn = document.querySelector('#nextSteps .action-btn') || document.getElementById('cardReadyWrap');
  if (btn) setLoading(btn, true);
  try {
    const data = await api('POST', '/api/resolve');
    if (data.error) {
      console.error('resolve error', data.error);
      return;
    }
    await Promise.all([loadStatus(), loadPortfolio(), loadReport(), loadTrades()]);
  } catch (e) {
    console.error('resolve failed', e);
  } finally {
    if (btn) setLoading(btn, false);
  }
}

// ═══════════════════════════════════════
//  RENDER REPORT
// ═══════════════════════════════════════

function renderReport() {
  const r = reportData;

  // Resolved sub info
  const resolvedSub = document.getElementById('cardResolvedSub');
  if (r.actual_wins || r.actual_losses) {
    resolvedSub.textContent = (r.actual_wins || 0) + ' won / ' + (r.actual_losses || 0) + ' lost';
  }

  const pnlSub = document.getElementById('cardPnlSub');
  if ((r.actual_wins || 0) + (r.actual_losses || 0) > 0) {
    pnlSub.textContent = 'Win rate: ' + ((r.actual_win_rate || 0) * 100).toFixed(0) + '%';
  }

  document.getElementById('reportAvgEdge').textContent = ((r.avg_edge || 0) * 100).toFixed(1) + '%';
  document.getElementById('reportAvgSize').textContent = '$' + (r.avg_size || 0).toFixed(2);
  document.getElementById('reportActualWL').textContent = (r.actual_wins || 0) + 'W / ' + (r.actual_losses || 0) + 'L';
  document.getElementById('reportActualWR').textContent = ((r.actual_win_rate || 0) * 100).toFixed(0) + '%';

  const tradesToday = snapshotsData.length > 0 ? snapshotsData[snapshotsData.length - 1].trades_today : 0;
  document.getElementById('utilizationValue').textContent = tradesToday;
  document.getElementById('utilizationValue').style.color = 'var(--blue)';

  const arcLen = Math.PI * 60;
  const pct = Math.min(1, (r.filled_trades || 0) / Math.max(1, 50));
  const arc = document.getElementById('utilizationArc');
  arc.setAttribute('stroke-dasharray', `${pct * arcLen} ${arcLen}`);
}

// ═══════════════════════════════════════
//  RENDER SIGNALS (human-readable)
// ═══════════════════════════════════════

function renderSignalRows(signals, tbodyId, sectionId, withCheckbox) {
  const section = document.getElementById(sectionId);
  const tbody = document.getElementById(tbodyId);
  if (!signals.length) { section.style.display = 'none'; return; }
  section.style.display = '';
  tbody.innerHTML = signals.map(s => {
    const desc = makeBetDescription(s);
    const noaaPct = (Math.abs(s.noaa_probability || 0) * 100).toFixed(0);
    const marketPct = (Math.abs(s.market_price || 0) * 100).toFixed(0);
    const edgePct = (Math.abs(s.edge || 0) * 100).toFixed(0);
    const edgeClass = Math.abs(s.edge) >= 0.15 ? 'edge-strong' : 'edge-marginal';
    const sideLabel = s.side === 'YES' ? 'Yes, it will' : 'No, it won\'t';
    const sideClass = s.side === 'YES' ? 'badge-yes' : 'badge-no';
    const risk = (s.recommended_size || 0).toFixed(2);
    const payout = (s.potential_payout || ((1 - (s.market_price || 0)) * (s.recommended_size || 0))).toFixed(2);
    const cb = withCheckbox ? `<td><input type="checkbox" class="signal-check" data-market-id="${s.market_id}" data-size="${s.recommended_size || 0}" checked></td>` : '';
    return `<tr>
      ${cb}
      <td style="color:var(--text-1);max-width:340px;overflow:hidden;text-overflow:ellipsis" title="${desc}">${desc}</td>
      <td style="color:var(--green)">${noaaPct}% likely</td>
      <td>${marketPct}% likely</td>
      <td class="${edgeClass}">${edgePct}%</td>
      <td><span class="badge ${sideClass}">${sideLabel}</span></td>
      <td style="color:var(--text-1)">$${risk} <span style="color:var(--green)">&rarr; win $${payout}</span></td>
    </tr>`;
  }).join('');
  if (withCheckbox) updateBetSlip();
}

// ═══════════════════════════════════════
//  RENDER MY BETS (lifecycle grouped)
// ═══════════════════════════════════════

function renderHistory() {
  const container = document.getElementById('historyLifecycle');
  const filter = document.getElementById('filterStatus').value;

  const open = tradesData.filter(t => t.lifecycle === 'open');
  const ready = tradesData.filter(t => t.lifecycle === 'ready');
  const resolved = tradesData.filter(t => t.lifecycle === 'resolved');

  let html = '';

  // Open Bets
  if (!filter || filter === 'open') {
    html += `<div class="lifecycle-section">
      <div class="lifecycle-header open">
        <h3>Open Bets</h3>
        <span class="lifecycle-count">${open.length}</span>
      </div>`;
    if (open.length === 0) {
      html += '<div class="lifecycle-empty">No open bets. Place some bets to get started.</div>';
    } else {
      html += open.map(t => renderBetCard(t, 'open')).join('');
    }
    html += '</div>';
  }

  // Ready to Resolve
  if (!filter || filter === 'ready') {
    html += `<div class="lifecycle-section">
      <div class="lifecycle-header ready" style="justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px">
          <h3>Ready to Resolve</h3>
          <span class="lifecycle-count">${ready.length}</span>
        </div>
        ${ready.length > 0 ? '<button class="action-btn amber" style="font-size:0.72rem;padding:4px 14px" onclick="doResolveFromDashboard()">Resolve All</button>' : ''}
      </div>`;
    if (ready.length === 0) {
      html += '<div class="lifecycle-empty">No bets ready to resolve yet. Weather events need to happen first.</div>';
    } else {
      html += ready.map(t => renderBetCard(t, 'ready')).join('');
    }
    html += '</div>';
  }

  // Resolved
  if (!filter || filter === 'resolved') {
    html += `<div class="lifecycle-section">
      <div class="lifecycle-header resolved">
        <h3>Resolved</h3>
        <span class="lifecycle-count">${resolved.length}</span>
      </div>`;
    if (resolved.length === 0) {
      html += '<div class="lifecycle-empty">No resolved bets yet. Resolve ready bets to see results.</div>';
    } else {
      html += '<div class="table-section"><table><thead><tr><th>The Bet</th><th>Position</th><th>Bet Size</th><th>Actual Weather</th><th>Result</th><th>Profit/Loss</th></tr></thead><tbody>';
      html += resolved.map(t => {
        const desc = t.question || t.location || t.market_id;
        const sideClass = t.side === 'YES' ? 'badge-yes' : 'badge-no';
        const outcomeClass = t.outcome === 'won' ? 'badge-won' : 'badge-lost';
        const pnl = t.actual_pnl != null ? t.actual_pnl : 0;
        const actualStr = t.actual_value != null ? `${t.actual_value.toFixed(1)}${t.actual_value_unit || ''}` : '--';
        return `<tr onclick="openTradeModal('${t.trade_id}')">
          <td style="color:var(--text-1);max-width:300px;overflow:hidden;text-overflow:ellipsis">${desc}</td>
          <td><span class="badge ${sideClass}">${t.side === 'YES' ? 'Yes' : 'No'}</span></td>
          <td>$${(t.size || 0).toFixed(2)}</td>
          <td>${actualStr}</td>
          <td><span class="badge ${outcomeClass}">${t.outcome || '?'}</span></td>
          <td><span class="${pnl >= 0 ? 'val-pos' : 'val-neg'}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</span></td>
        </tr>`;
      }).join('');
      html += '</tbody></table></div>';
    }
    html += '</div>';
  }

  container.innerHTML = html;
}

function renderBetCard(t, type) {
  const desc = t.question || t.location || t.market_id;
  const sideLabel = t.side === 'YES' ? 'Yes' : 'No';
  const sideClass = t.side === 'YES' ? 'badge-yes' : 'badge-no';
  const size = (t.size || 0).toFixed(2);
  const payout = (t.potential_payout || 0).toFixed(2);
  const cd = countdownText(t.days_until_event);
  const cdClass = type === 'ready' ? 'countdown-ready' : 'countdown-future';
  const metaItems = [t.location || '', t.event_date ? formatDate(t.event_date) : ''].filter(Boolean);

  return `<div class="bet-card" onclick="openTradeModal('${t.trade_id}')">
    <span class="badge ${sideClass}" style="flex-shrink:0">${sideLabel}</span>
    <div class="bet-card-main">
      <div class="bet-card-desc">${desc}</div>
      <div class="bet-card-meta">${metaItems.map(m => `<span>${m}</span>`).join('')}</div>
    </div>
    <div class="bet-card-money">
      <div class="bet-card-stake">$${size}</div>
      <div class="bet-card-payout">win up to $${payout}</div>
    </div>
    ${cd ? `<span class="bet-card-countdown ${cdClass}">${cd}</span>` : ''}
  </div>`;
}

// ═══════════════════════════════════════
//  TRADE DETAIL MODAL
// ═══════════════════════════════════════

async function openTradeModal(tradeId) {
  const overlay = document.getElementById('tradeModal');
  const content = document.getElementById('modalContent');
  content.innerHTML = '<div style="text-align:center;color:var(--text-3);padding:20px">Loading...</div>';
  overlay.classList.add('open');

  try {
    const t = await api('GET', '/api/trades/' + tradeId);
    if (t.error) { content.innerHTML = `<div style="color:var(--red)">${t.error}</div>`; return; }

    const desc = t.question || t.location || t.market_id;
    const sideLabel = t.side === 'YES' ? 'Yes, it will happen' : 'No, it won\'t happen';
    const cd = countdownText(t.days_until_event);

    let lifecycleBadge = '';
    if (t.lifecycle === 'open') lifecycleBadge = '<span class="badge badge-open">Open</span>';
    else if (t.lifecycle === 'ready') lifecycleBadge = '<span class="badge badge-ready">Ready to Resolve</span>';
    else if (t.lifecycle === 'resolved') lifecycleBadge = t.outcome === 'won' ? '<span class="badge badge-won">Won</span>' : '<span class="badge badge-lost">Lost</span>';

    let html = `<div class="modal-title">${desc}</div>`;
    html += `<div style="margin-bottom:16px">${lifecycleBadge} ${cd ? `<span style="color:var(--text-3);font-size:0.75rem;margin-left:8px">${cd}</span>` : ''}</div>`;

    html += '<div class="modal-section-label">Bet Details</div>';
    html += `<div class="modal-row"><span class="modal-row-label">Position</span><span class="modal-row-value">${sideLabel}</span></div>`;
    html += `<div class="modal-row"><span class="modal-row-label">Bet Size</span><span class="modal-row-value">$${(t.size || 0).toFixed(2)}</span></div>`;
    html += `<div class="modal-row"><span class="modal-row-label">Entry Price</span><span class="modal-row-value">$${(t.price || 0).toFixed(2)}</span></div>`;
    html += `<div class="modal-row"><span class="modal-row-label">Potential Payout</span><span class="modal-row-value" style="color:var(--green)">$${(t.potential_payout || 0).toFixed(2)}</span></div>`;

    html += '<div class="modal-section-label">The Edge</div>';
    html += `<div class="modal-row"><span class="modal-row-label">NOAA Says</span><span class="modal-row-value" style="color:var(--green)">${((t.noaa_probability || 0) * 100).toFixed(0)}% likely</span></div>`;
    const marketProb = t.side === 'YES' ? (t.price || 0) : 1 - (t.price || 0);
    html += `<div class="modal-row"><span class="modal-row-label">Market Says</span><span class="modal-row-value">${(marketProb * 100).toFixed(0)}% likely</span></div>`;
    html += `<div class="modal-row"><span class="modal-row-label">Our Edge</span><span class="modal-row-value" style="color:var(--green)">${((t.edge || 0) * 100).toFixed(0)}%</span></div>`;

    html += '<div class="modal-section-label">Timeline</div>';
    const placedDate = t.timestamp ? new Date(t.timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }) : '';
    html += `<div class="modal-row"><span class="modal-row-label">Bet Placed</span><span class="modal-row-value">${placedDate}</span></div>`;
    html += `<div class="modal-row"><span class="modal-row-label">Weather Event</span><span class="modal-row-value">${t.event_date ? formatDate(t.event_date) : 'Unknown'}</span></div>`;

    // NOAA Forecast at bet time
    if (t.noaa_forecast_high != null || t.noaa_forecast_low != null || t.noaa_forecast_narrative) {
      html += '<div class="modal-section-label">NOAA Forecast at Bet Time</div>';
      if (t.noaa_forecast_high != null) html += `<div class="modal-row"><span class="modal-row-label">Forecast High</span><span class="modal-row-value">${t.noaa_forecast_high.toFixed(0)}\u00b0F</span></div>`;
      if (t.noaa_forecast_low != null) html += `<div class="modal-row"><span class="modal-row-label">Forecast Low</span><span class="modal-row-value">${t.noaa_forecast_low.toFixed(0)}\u00b0F</span></div>`;
      if (t.noaa_forecast_narrative) html += `<div class="modal-row"><span class="modal-row-label">Forecast</span><span class="modal-row-value" style="max-width:280px;white-space:normal;text-align:right;line-height:1.4">${escapeHtml(t.noaa_forecast_narrative)}</span></div>`;
    }

    if (t.lifecycle === 'resolved') {
      html += '<div class="modal-section-label">Result</div>';
      const pnl = t.actual_pnl || 0;
      html += `<div class="modal-row"><span class="modal-row-label">Outcome</span><span class="modal-row-value">${t.outcome === 'won' ? '<span style="color:var(--green)">WON</span>' : '<span style="color:var(--red)">LOST</span>'}</span></div>`;
      if (t.actual_value != null) {
        const unit = t.actual_value_unit || '';
        const thr = formatThreshold(t.threshold, t.metric);
        html += `<div class="modal-row"><span class="modal-row-label">Actual Weather</span><span class="modal-row-value">${t.actual_value.toFixed(1)}${unit} vs ${thr} threshold</span></div>`;
      }
      html += `<div class="modal-row"><span class="modal-row-label">Actual P&L</span><span class="modal-row-value ${pnl >= 0 ? 'val-pos' : 'val-neg'}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</span></div>`;
    }

    content.innerHTML = html;
  } catch (e) {
    content.innerHTML = `<div style="color:var(--red)">Failed to load trade details.</div>`;
  }
}

document.getElementById('modalClose').addEventListener('click', () => {
  document.getElementById('tradeModal').classList.remove('open');
});
document.getElementById('tradeModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
});

// ═══════════════════════════════════════
//  CHART
// ═══════════════════════════════════════

function getChartData() {
  if (!snapshotsData.length) return [];
  const sliced = currentRange === 'all' ? snapshotsData : snapshotsData.slice(-currentRange);
  return sliced.map(s => ({
    date: new Date(s.snapshot_date),
    value: parseFloat(s.total_value),
  }));
}

function drawChart() {
  const canvas = document.getElementById('plChart');
  const wrap = document.getElementById('chartWrap');
  const dpr = window.devicePixelRatio || 1;
  const rect = wrap.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  const w = rect.width;
  const h = rect.height;

  const data = getChartData();
  if (!data.length) {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#505370';
    ctx.font = '13px JetBrains Mono';
    ctx.textAlign = 'center';
    ctx.fillText('No snapshot data yet. Run simulations to populate.', w / 2, h / 2);
    return;
  }

  const pad = { top: 10, right: 16, bottom: 28, left: 56 };
  const values = data.map(d => d.value);
  const minV = Math.floor(Math.min(...values) / 5) * 5 - 5;
  const maxV = Math.ceil(Math.max(...values) / 5) * 5 + 5;
  const chartW = w - pad.left - pad.right;
  const chartH = h - pad.top - pad.bottom;

  function xPos(i) { return pad.left + (i / Math.max(1, data.length - 1)) * chartW; }
  function yPos(v) { return pad.top + (1 - (v - minV) / (maxV - minV)) * chartH; }

  ctx.clearRect(0, 0, w, h);

  ctx.strokeStyle = 'rgba(30,32,46,0.6)';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  for (let i = 0; i <= 5; i++) {
    const v = minV + (maxV - minV) * (i / 5);
    const y = yPos(v);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#505370'; ctx.font = '10px JetBrains Mono'; ctx.textAlign = 'right';
    ctx.fillText('$' + Math.round(v), pad.left - 8, y + 3);
  }
  ctx.setLineDash([]);

  ctx.fillStyle = '#505370'; ctx.font = '10px JetBrains Mono'; ctx.textAlign = 'center';
  const labelEvery = Math.max(1, Math.floor(data.length / 6));
  for (let i = 0; i < data.length; i += labelEvery) {
    const d = data[i].date;
    ctx.fillText((d.getMonth() + 1) + '/' + d.getDate(), xPos(i), h - 6);
  }

  ctx.beginPath();
  ctx.moveTo(xPos(0), yPos(values[0]));
  for (let i = 1; i < data.length; i++) {
    const x0 = xPos(i - 1), y0 = yPos(values[i - 1]);
    const x1 = xPos(i), y1 = yPos(values[i]);
    ctx.bezierCurveTo((x0 + x1) / 2, y0, (x0 + x1) / 2, y1, x1, y1);
  }
  ctx.strokeStyle = '#4d8eff'; ctx.lineWidth = 2; ctx.stroke();

  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + chartH);
  grad.addColorStop(0, 'rgba(77,142,255,0.15)');
  grad.addColorStop(1, 'rgba(77,142,255,0)');
  ctx.beginPath();
  ctx.moveTo(xPos(0), yPos(values[0]));
  for (let i = 1; i < data.length; i++) {
    const x0 = xPos(i - 1), y0 = yPos(values[i - 1]);
    const x1 = xPos(i), y1 = yPos(values[i]);
    ctx.bezierCurveTo((x0 + x1) / 2, y0, (x0 + x1) / 2, y1, x1, y1);
  }
  ctx.lineTo(xPos(data.length - 1), pad.top + chartH);
  ctx.lineTo(xPos(0), pad.top + chartH);
  ctx.closePath(); ctx.fillStyle = grad; ctx.fill();

  canvas._chartMeta = { data, pad, chartW, chartH, minV, maxV, xPos, yPos, w, h };
}

function setupChartHover() {
  const canvas = document.getElementById('plChart');
  const tooltip = document.getElementById('chartTooltip');
  const crosshair = document.getElementById('chartCrosshair');
  canvas.addEventListener('mousemove', e => {
    const meta = canvas._chartMeta;
    if (!meta || !meta.data.length) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    if (mx < meta.pad.left || mx > meta.w - meta.pad.right) {
      tooltip.classList.remove('visible'); crosshair.classList.remove('visible'); return;
    }
    const ratio = (mx - meta.pad.left) / meta.chartW;
    const idx = Math.max(0, Math.min(meta.data.length - 1, Math.round(ratio * (meta.data.length - 1))));
    const pt = meta.data[idx];
    const x = meta.xPos(idx);
    tooltip.innerHTML = `<div style="color:var(--text-3);margin-bottom:2px">${pt.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div><div style="font-weight:600;color:var(--blue)">$${pt.value.toFixed(2)}</div>`;
    tooltip.style.left = (x + 12) + 'px';
    tooltip.style.top = (meta.yPos(pt.value) - 20) + 'px';
    tooltip.classList.add('visible');
    crosshair.style.left = x + 'px';
    crosshair.classList.add('visible');
  });
  canvas.addEventListener('mouseleave', () => {
    tooltip.classList.remove('visible'); crosshair.classList.remove('visible');
  });
}

// ═══════════════════════════════════════
//  ACTION HELPERS
// ═══════════════════════════════════════

function showOutput(id, html) {
  const el = document.getElementById(id);
  el.innerHTML = html;
  el.classList.add('visible');
}

function hideOutput(id) {
  document.getElementById(id).classList.remove('visible');
}

function setLoading(btn, loading) {
  btn.disabled = loading;
  if (loading) btn.classList.add('loading');
  else btn.classList.remove('loading');
}

// ═══════════════════════════════════════
//  ACTIONS: SCAN
// ═══════════════════════════════════════

document.getElementById('scanBtn').addEventListener('click', async function() {
  setLoading(this, true);
  hideOutput('scanOutput');
  try {
    const data = await api('POST', '/api/scan');
    if (data.error) {
      showOutput('scanOutput', `<span class="error">Scan failed: ${data.error}</span>`);
    } else {
      signalsData = data.signals || [];
      localStorage.setItem('lastScanSignals', JSON.stringify(signalsData));
      localStorage.setItem('lastScanTime', new Date().toISOString());
      renderSignalRows(signalsData, 'signalsBody', 'signalsSection', false);
      updateScanTime();
      showOutput('scanOutput', `<span class="success">Scan complete.</span> Found <span class="info">${data.count}</span> opportunities.`);
    }
  } catch (e) {
    showOutput('scanOutput', `<span class="error">Scan failed: ${e.message}</span>`);
  }
  setLoading(this, false);
});

function updateScanTime() {
  const t = localStorage.getItem('lastScanTime');
  const el = document.getElementById('scanLastTime');
  if (t) {
    const d = new Date(t);
    el.textContent = 'Last scan: ' + d.toLocaleString();
  }
}

// ═══════════════════════════════════════
//  ACTIONS: SIMULATE
// ═══════════════════════════════════════

// Step 1: Find opportunities (scan only, no execution)
document.getElementById('simFindBtn').addEventListener('click', async function() {
  setLoading(this, true);
  hideOutput('simOutput');
  document.getElementById('betSlip').style.display = 'none';
  try {
    const data = await api('POST', '/api/scan');
    if (data.error) {
      showOutput('simOutput', `<span class="error">Scan failed: ${data.error}</span>`);
    } else {
      simSignalsData = data.signals || [];
      if (!simSignalsData.length) {
        showOutput('simOutput', `<span class="info">No actionable opportunities found right now.</span>`);
        document.getElementById('simSignalsSection').style.display = 'none';
      } else {
        renderSignalRows(simSignalsData, 'simSignalsBody', 'simSignalsSection', true);
        showOutput('simOutput', `<span class="success">Found ${simSignalsData.length} opportunities.</span> Select which bets to place, then click "Place Bets".`);
      }
    }
  } catch (e) {
    showOutput('simOutput', `<span class="error">Scan failed: ${e.message}</span>`);
  }
  setLoading(this, false);
});

// Bet slip: update counts when checkboxes change
function updateBetSlip() {
  const checks = document.querySelectorAll('.signal-check:checked');
  const slip = document.getElementById('betSlip');
  if (checks.length === 0) { slip.style.display = 'none'; return; }
  slip.style.display = 'block';
  let total = 0;
  checks.forEach(c => { total += parseFloat(c.dataset.size || 0); });
  document.getElementById('slipCount').textContent = checks.length;
  document.getElementById('slipTotal').textContent = '$' + total.toFixed(2);
}

document.addEventListener('change', e => {
  if (e.target.classList.contains('signal-check') || e.target.id === 'checkAll') {
    if (e.target.id === 'checkAll') {
      document.querySelectorAll('.signal-check').forEach(c => { c.checked = e.target.checked; });
    } else {
      // Update checkAll state when individual checkbox changes
      const all = document.querySelectorAll('.signal-check');
      const checkAllEl = document.getElementById('checkAll');
      if (checkAllEl) checkAllEl.checked = [...all].every(c => c.checked);
    }
    updateBetSlip();
  }
});

document.getElementById('selectAllBtn').addEventListener('click', () => {
  const checks = document.querySelectorAll('.signal-check');
  const allChecked = [...checks].every(c => c.checked);
  checks.forEach(c => { c.checked = !allChecked; });
  document.getElementById('checkAll').checked = !allChecked;
  updateBetSlip();
});

// Step 2: Place selected bets
document.getElementById('placeBetsBtn').addEventListener('click', async function() {
  const checks = document.querySelectorAll('.signal-check:checked');
  if (!checks.length) return;
  const marketIds = [...checks].map(c => c.dataset.marketId);
  setLoading(this, true);
  try {
    const data = await api('POST', '/api/sim/execute', { market_ids: marketIds });
    if (data.error) {
      showOutput('simOutput', `<span class="error">Failed: ${data.error}</span>`);
    } else {
      const trades = data.trades || [];
      const totalWagered = trades.reduce((sum, t) => sum + (t.size || 0), 0);
      let msg = `<span class="success">Placed ${trades.length} bet${trades.length !== 1 ? 's' : ''} totaling $${totalWagered.toFixed(2)}.</span>`;
      if (data.skipped > 0) msg += ` <span style="color:var(--text-3)">(${data.skipped} skipped)</span>`;
      const reasons = data.skip_reasons || [];
      if (reasons.length) {
        msg += '\n<span style="color:var(--text-3);font-size:0.85em">';
        reasons.forEach(r => { msg += `\n&bull; ${r.reason}`; });
        msg += '</span>';
      }
      showOutput('simOutput', msg);
      document.getElementById('betSlip').style.display = 'none';
      document.getElementById('simSignalsSection').style.display = 'none';
      await Promise.all([loadPortfolio(), loadReport(), loadTrades(), loadSnapshots()]);
      updateOnboarding();
    }
  } catch (e) {
    showOutput('simOutput', `<span class="error">Failed: ${e.message}</span>`);
  }
  setLoading(this, false);
});

// ═══════════════════════════════════════
//  ACTIONS: RESOLVE
// ═══════════════════════════════════════

document.getElementById('resolveBtn').addEventListener('click', async function() {
  setLoading(this, true);
  hideOutput('simOutput');
  try {
    const data = await api('POST', '/api/resolve');
    if (data.error) {
      showOutput('simOutput', `<span class="error">Resolution failed: ${data.error}</span>`);
    } else {
      let msg = `<span class="success">Resolution complete.</span>\n`;
      msg += `Resolved: <span class="info">${data.resolved_count}</span>`;
      if (data.resolved_count > 0) {
        msg += ` | Won: <span class="success">${data.wins}</span> | Lost: <span class="error">${data.losses}</span>`;
        msg += ` | P&L: <span class="${data.total_pnl >= 0 ? 'success' : 'error'}">$${(data.total_pnl || 0).toFixed(2)}</span>`;
      }
      if (data.skipped_future > 0) {
        msg += `\n<span style="color:var(--text-3)">${data.skipped_future} bet(s) skipped &mdash; weather hasn't happened yet.</span>`;
      }
      showOutput('simOutput', msg);
      await Promise.all([loadStatus(), loadPortfolio(), loadReport(), loadTrades()]);
    }
  } catch (e) {
    showOutput('simOutput', `<span class="error">Resolution failed: ${e.message}</span>`);
  }
  setLoading(this, false);
});

// ═══════════════════════════════════════
//  ACTIVITY LOG
// ═══════════════════════════════════════

async function pollLogs() {
  try {
    const data = await api('GET', `/api/logs?since=${logCursor}`);
    if (data.logs && data.logs.length > 0) {
      logEntries = logEntries.concat(data.logs);
      if (logEntries.length > 500) logEntries = logEntries.slice(-500);
      logCursor = data.cursor;
      renderLogs();
    }
  } catch (e) { /* silent */ }
}

function renderLogs() {
  const viewer = document.getElementById('logViewer');
  const levelFilter = document.getElementById('logLevelFilter').value;
  const filtered = levelFilter ? logEntries.filter(e => e.level === levelFilter) : logEntries;

  if (!filtered.length) {
    viewer.innerHTML = '<div style="color:var(--text-3);text-align:center;padding:20px">Waiting for activity...</div>';
    return;
  }

  viewer.innerHTML = filtered.slice(-200).map(e => {
    const time = e.timestamp ? e.timestamp.split('T')[1]?.slice(0, 8) || '' : '';
    const level = (e.level || 'info').toLowerCase();
    const extras = Object.keys(e).filter(k => !['timestamp', 'level', 'event', 'id'].includes(k));
    const extraStr = extras.length ? ` <span class="log-extra">${extras.map(k => k + '=' + e[k]).join(' ')}</span>` : '';
    return `<div class="log-entry"><span class="log-time">${time}</span><span class="log-level ${level}">${level}</span><span class="log-msg">${e.event || ''}${extraStr}</span></div>`;
  }).join('');

  if (logAutoScroll) viewer.scrollTop = viewer.scrollHeight;
}

document.getElementById('logLevelFilter').addEventListener('change', renderLogs);
document.getElementById('clearLogsBtn').addEventListener('click', () => {
  logEntries = [];
  renderLogs();
});
document.getElementById('autoScrollBtn').addEventListener('click', function() {
  logAutoScroll = !logAutoScroll;
  this.classList.toggle('active', logAutoScroll);
});

setInterval(pollLogs, 3000);

// ═══════════════════════════════════════
//  KILL SWITCH
// ═══════════════════════════════════════

document.getElementById('killSwitch').addEventListener('change', async function() {
  await api('PUT', '/api/kill-switch', { enabled: this.checked });
  await loadStatus();
});

document.getElementById('settingsKillSwitch').addEventListener('change', async function() {
  document.getElementById('killSwitch').checked = this.checked;
  await api('PUT', '/api/kill-switch', { enabled: this.checked });
  await loadStatus();
});

// ═══════════════════════════════════════
//  SETTINGS
// ═══════════════════════════════════════

document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
  const body = {
    max_bankroll: parseFloat(document.getElementById('cfgBankroll').value),
    position_cap_pct: parseFloat(document.getElementById('cfgPositionCap').value) / 100,
    kelly_fraction: parseFloat(document.getElementById('cfgKelly').value),
    min_edge_threshold: parseFloat(document.getElementById('cfgMinEdge').value) / 100,
    daily_loss_limit_pct: parseFloat(document.getElementById('cfgDailyLoss').value) / 100,
    log_level: document.getElementById('cfgLogLevel').value,
    kill_switch: document.getElementById('settingsKillSwitch').checked,
  };
  await api('PUT', '/api/settings', body);
  await loadStatus();
  const btn = document.getElementById('saveSettingsBtn');
  const orig = btn.textContent;
  btn.textContent = 'Saved!';
  btn.style.background = 'var(--green)';
  setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 1500);
});

// ═══════════════════════════════════════
//  FILTERS & CHART RANGE
// ═══════════════════════════════════════

document.getElementById('filterStatus').addEventListener('change', renderHistory);

document.querySelectorAll('.pill-btn[data-range]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.pill-btn[data-range]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentRange = btn.dataset.range === 'all' ? 'all' : parseInt(btn.dataset.range);
    drawChart();
  });
});

// ═══════════════════════════════════════
//  POSITIONS & P&L
// ═══════════════════════════════════════

async function loadPositions() {
  try {
    positionsData = await api('GET', '/api/positions');
    renderPositions();
  } catch (e) { console.error('positions load failed', e); }
}

function renderPositions() {
  const positions = positionsData.positions ?? [];
  const summary = positionsData.summary ?? {};

  // Summary cards
  document.getElementById('posCount').textContent = summary.position_count || 0;

  const exposure = summary.total_exposure || 0;
  document.getElementById('posExposure').textContent = '$' + exposure.toFixed(2);

  const expectedPnl = summary.total_expected_pnl || 0;
  const expectedEl = document.getElementById('posExpectedPnl');
  expectedEl.textContent = (expectedPnl >= 0 ? '+' : '') + '$' + expectedPnl.toFixed(2);
  expectedEl.className = 'card-value ' + (expectedPnl >= 0 ? 'positive' : 'negative');

  const expectedReturn = summary.total_expected_return || 0;
  document.getElementById('posExpectedReturn').textContent = (expectedReturn * 100).toFixed(1) + '% expected return';

  const maxProfit = summary.total_max_profit || 0;
  const maxProfitEl = document.getElementById('posMaxProfit');
  maxProfitEl.textContent = '+$' + maxProfit.toFixed(2);
  maxProfitEl.className = 'card-value positive';

  const maxLoss = summary.total_max_loss || 0;
  document.getElementById('posMaxLoss').textContent = 'Max loss: -$' + Math.abs(maxLoss).toFixed(2);

  // Scenario bar
  const scenarioWrap = document.getElementById('posScenarioWrap');
  if (positions.length > 0) {
    scenarioWrap.style.display = 'block';
    document.getElementById('scenarioLoss').textContent = '-$' + Math.abs(maxLoss).toFixed(0);
    document.getElementById('scenarioProfit').textContent = '+$' + maxProfit.toFixed(0);

    const range = maxProfit - maxLoss;
    const markerPos = range > 0 ? ((expectedPnl - maxLoss) / range) * 100 : 50;
    document.getElementById('scenarioMarker').style.left = Math.max(2, Math.min(98, markerPos)) + '%';
    document.getElementById('scenarioExpected').textContent = 'Expected: ' + (expectedPnl >= 0 ? '+' : '') + '$' + expectedPnl.toFixed(2);
  } else {
    scenarioWrap.style.display = 'none';
  }

  // Table
  const tbody = document.getElementById('posTableBody');
  if (!positions.length) {
    tbody.innerHTML = '<tr class="empty-row"><td colspan="9">No open positions. Place bets to see P&L estimates.</td></tr>';
    return;
  }

  tbody.innerHTML = positions.map(pos => {
    const desc = makeBetDescription(pos);
    const sideBadge = pos.side === 'YES' ? '<span class="badge badge-yes">YES</span>' : '<span class="badge badge-no">NO</span>';
    const maxProfitCls = 'val-pos';
    const maxLossCls = 'val-neg';
    const expectedCls = pos.expected_pnl >= 0 ? 'val-pos' : 'val-neg';
    const eventStr = pos.event_date ? formatDate(pos.event_date) : '';
    const daysStr = pos.days_until_event != null ? ` (${pos.days_until_event}d)` : '';

    return `<tr onclick="openTradeModal('${pos.trade_id}')">
      <td style="max-width:260px;overflow:hidden;text-overflow:ellipsis" title="${desc}">${desc}</td>
      <td>${sideBadge}</td>
      <td>$${pos.size.toFixed(2)}</td>
      <td>${pos.entry_price.toFixed(2)}</td>
      <td>${(pos.noaa_probability * 100).toFixed(0)}%</td>
      <td class="${maxProfitCls}">+$${pos.max_profit.toFixed(2)}</td>
      <td class="${maxLossCls}">-$${Math.abs(pos.max_loss).toFixed(2)}</td>
      <td class="${expectedCls}" style="font-weight:600">${pos.expected_pnl >= 0 ? '+' : ''}$${pos.expected_pnl.toFixed(2)}</td>
      <td>${eventStr}${daysStr}</td>
    </tr>`;
  }).join('');
}

// ═══════════════════════════════════════
//  INIT
// ═══════════════════════════════════════

const savedSignals = localStorage.getItem('lastScanSignals');
if (savedSignals) {
  try {
    signalsData = JSON.parse(savedSignals);
    renderSignalRows(signalsData, 'signalsBody', 'signalsSection', false);
  } catch(e) { /* ignore */ }
}
updateScanTime();

loadAll();
setupChartHover();
window.addEventListener('resize', drawChart);
pollLogs();

// Auto-refresh status + portfolio every 60s
setInterval(async () => {
  await Promise.all([loadStatus(), loadPortfolio()]);
}, 60000);
</script>
</body>
</html>
